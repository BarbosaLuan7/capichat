# Recommended Approach: Estabilizacao CapiChat

**Generated:** 2026-01-22
**Generated By:** @architect (Aria)
**Feature:** Limpeza Lovable + Verificacao Edge Functions + Avaliacao Monorepo

---

## Executive Summary

O projeto CapiChat esta em bom estado arquitetural. A migracao do Lovable para Google Gemini ja foi feita. Os principais pontos de atencao sao:

1. **Residuos do Lovable** - Apenas referencias em lock files (facil limpar)
2. **Monorepo** - NAO recomendado agora (estrutura atual funciona bem)
3. **Edge Functions** - Bem organizadas, verificar JWT em endpoints criticos

---

## Plano de Acao

### Fase 1: Limpeza Imediata (30 min)

```bash
# No diretorio do projeto
cd /Users/luanbarbosa/capichat

# 1. Remover pacotes extraneous
npm prune

# 2. Verificar se lovable-tagger foi removido
npm ls lovable-tagger  # Deve retornar "empty"

# 3. Regenerar lock files limpos
rm package-lock.json
npm install

# 4. Verificar Edge Functions
cd supabase/functions
deno cache --reload _shared/index.ts
```

### Fase 2: Verificacao de Seguranca (1-2 dias)

Auditar as seguintes Edge Functions para JWT verification:

**Prioridade Alta (dados sensiveis):**

- [ ] api-leads
- [ ] api-conversations
- [ ] api-messages-send
- [ ] api-users

**Prioridade Media (operacoes):**

- [ ] api-webhooks
- [ ] api-templates
- [ ] api-teams

### Fase 3: Testes (continuo)

Corrigir testes falhando em `src/lib/errorMessages.test.ts` e adicionar testes para hooks criticos.

---

## Decisoes Arquiteturais

### Monorepo: NAO Recomendado

**Motivo:** O projeto ja funciona como um monorepo informal. Adicionar Turborepo/Nx/pnpm workspaces traria complexidade sem beneficio proporcional para um projeto single-team.

**Revisitar se:**

- Time crescer para 3+ devs trabalhando simultaneamente
- Surgir necessidade de compartilhar codigo entre multiplos frontends
- Deploy do frontend precisar ser separado das Edge Functions

### Estrutura de Edge Functions: MANTER

A organizacao atual com `_shared/` para modulos comuns e handlers/processors/validators no whatsapp-webhook e um bom padrao. Replicar para outras functions grandes se necessario.

### AI Provider: MANTER Gemini

O Google Gemini 2.5 Flash esta funcionando bem. O client em `_shared/gemini.ts` e robusto e suporta:

- Chat completions
- Function calling
- Audio transcription

---

## Agent Assignment

| Role      | Agent      | Responsabilidades              |
| --------- | ---------- | ------------------------------ |
| Primary   | @dev       | Executar limpeza e correcoes   |
| Support   | @qa        | Verificar testes e cobertura   |
| Oversight | @architect | Revisar decisoes arquiteturais |

---

## Success Criteria

- [ ] `npm ls lovable-tagger` retorna empty
- [ ] `npm audit` sem vulnerabilidades high/critical
- [ ] Testes passando (`npm test`)
- [ ] Edge Functions funcionando (testar endpoints principais)

---

## Timeline

| Fase            | Duracao  | Responsavel |
| --------------- | -------- | ----------- |
| Limpeza Lovable | 30 min   | @dev        |
| Verificacao JWT | 1-2 dias | @dev + @qa  |
| Correcao Testes | 1 dia    | @qa         |

**Total estimado:** 2-3 dias para estabilizacao completa

---

_â€” Aria, arquitetando o futuro_
