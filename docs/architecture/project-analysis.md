# Project Analysis: CapiChat

**Generated:** 2026-01-22
**Generated By:** @architect (Aria)
**Analysis Type:** Comprehensive (Lovable Cleanup + Monorepo + Edge Functions)

---

## 1. Project Structure

| Aspecto           | Valor                                  |
| ----------------- | -------------------------------------- |
| Framework         | React 18 + Vite + TypeScript           |
| Backend           | Supabase (Edge Functions + PostgreSQL) |
| AI Provider       | Google Gemini 2.5 Flash                |
| Primary Language  | TypeScript (100%)                      |
| Testing Framework | Vitest                                 |
| UI Framework      | shadcn-ui + Tailwind CSS               |

### File Distribution

| Location               | Files      | Purpose                       |
| ---------------------- | ---------- | ----------------------------- |
| `/src`                 | 243 TS/TSX | Frontend React                |
| `/supabase/functions`  | 77 TS      | Edge Functions (48 functions) |
| `/supabase/migrations` | 67 SQL     | Database migrations           |
| `/.aios-core`          | Framework  | AIOS Agent System             |

---

## 2. Residuos do Lovable

### Encontrados

| Item             | Location           | Status       | Acao                    |
| ---------------- | ------------------ | ------------ | ----------------------- |
| `lovable-tagger` | package-lock.json  | Extraneous   | Remover com `npm prune` |
| `lovable-tagger` | deno.lock          | Cached       | Regenerar lock          |
| Comentarios      | gemini.ts:2        | Documentacao | Opcional remover        |
| Referencias      | docs/analise-\*.md | Documentacao | Manter (historico)      |

### Ja Removidos

- `lovable-tagger` NAO esta no package.json (ja foi removido da lista de deps)
- Gateway do Lovable substituido por Google Gemini direto
- Todas as funcoes de IA agora usam `_shared/gemini.ts`

### Acoes para Limpeza Completa

```bash
# 1. Remover pacote extraneous do node_modules
npm prune

# 2. Regenerar package-lock.json limpo
rm package-lock.json
npm install

# 3. Regenerar deno.lock (nas Edge Functions)
cd supabase/functions
deno cache --reload _shared/gemini.ts
```

---

## 3. Edge Functions Audit

### Inventory (48 functions)

**AI Functions (5)** - Todas usando Gemini:

- `ai-classify-lead` - Classificacao automatica de leads
- `ai-detect-reminders` - Deteccao de lembretes em mensagens
- `ai-suggest-replies` - Sugestoes de resposta
- `ai-summarize-conversation` - Resumo de conversas
- `transcribe-audio` - Transcricao de audio

**WhatsApp Functions (10)**:

- `whatsapp-webhook` - Principal (WAHA + Meta)
- `send-whatsapp-message` - Envio de mensagens
- `api-messages-send` - API de envio
- `api-messages-receive` - API de recebimento
- `get-whatsapp-avatar` - Avatar do contato
- `delete-whatsapp-message` - Deletar mensagem
- `repair-message-media` - Recuperar midia
- `sync-chat-history` - Sincronizar historico
- `whatsapp-test-connection` - Testar conexao
- `whatsapp-test-message` - Testar mensagem

**API Functions (15)**: api-arquivos, api-campos-personalizados, api-carteiras, api-chatbots, api-contatos-lote, api-conversations, api-funnels, api-lead-summary, api-leads, api-mensagens, api-mensagens-agendadas, api-oportunidades, api-tags, api-tasks, api-teams, api-templates, api-users, api-webhooks, api-whatsapp-instances

**Utility Functions (8)**: admin-create-user, check-webhooks, check-whatsapp-config, create-n8n-webhook, create-test-api-key, debug-webhook-logs, dispatch-webhook, process-automations, process-webhook-queue, refresh-lead-avatars, resolve-facebook-lids, n8n-ai-response

### Shared Modules (`_shared/`)

| Module            | Purpose                    | Lines |
| ----------------- | -------------------------- | ----- |
| gemini.ts         | Google AI client           | 272   |
| phone.ts          | Phone number parsing       | ~400  |
| message-parser.ts | Message content extraction | ~330  |
| waha-client.ts    | WAHA API client            | ~220  |
| contact.ts        | Contact management         | ~250  |
| lead-search.ts    | Lead search utilities      | ~220  |
| media.ts          | Media handling             | ~210  |

### Architecture Quality

**Positivo:**

- Modulos compartilhados bem organizados em `_shared/`
- whatsapp-webhook refatorado com handlers/processors/validators
- Gemini client centralizado
- Tipos bem definidos

**Atencao:**

- Verificar JWT em endpoints publicos
- Algumas functions ainda grandes (api-leads)

---

## 4. Monorepo Evaluation

### Current Structure (Pseudo-Monorepo)

```
capichat/
├── src/                    # Frontend (React)
├── supabase/
│   ├── functions/          # Backend (Edge Functions)
│   └── migrations/         # Database
├── .aios-core/             # AI Agent Framework
└── docs/                   # Documentation
```

### Recommendation: Manter Estrutura Atual

**Razoes:**

1. **Ja funciona como monorepo** - Frontend e backend no mesmo repo
2. **Supabase Edge Functions** - Tem deploy proprio (`supabase functions deploy`)
3. **Sem necessidade de workspaces** - Nao ha compartilhamento de codigo entre packages
4. **Complexidade desnecessaria** - Turborepo/Nx adicionaria overhead sem beneficio

### Se Quiser Evoluir para Monorepo Formal

```
capichat/
├── apps/
│   └── web/                # Frontend React (mover /src)
├── packages/
│   ├── shared/             # Tipos compartilhados
│   └── ui/                 # Componentes shadcn customizados
├── supabase/               # Manter como esta
└── tooling/
    └── eslint-config/      # Configs compartilhadas
```

**Custo:** 2-3 dias de refatoracao
**Beneficio:** Baixo (projeto single-team)

---

## 5. Pattern Summary

### Language Distribution

- **TypeScript:** 100% (320+ files)
- **JavaScript:** 0%

### Testing

- **Framework:** Vitest
- **Test Files:** 8
- **Coverage:** Baixa (~5%)

### Configuration

- **Environment Variables:** .env (nao commitado)
- **Config Files:** vite.config.ts, tailwind.config.ts, tsconfig.json

### Code Quality

- **ESLint:** Configurado
- **Prettier:** Configurado
- **Husky:** Pre-commit hooks ativos
- **lint-staged:** Configurado

---

## 6. Technical Debt Summary

| Prioridade | Item                                     | Esforco  |
| ---------- | ---------------------------------------- | -------- |
| P0         | Limpar residuos Lovable (npm prune)      | 10 min   |
| P1         | Verificar JWT em Edge Functions criticas | 1-2 dias |
| P1         | Aumentar cobertura de testes             | Continuo |
| P2         | Documentar Edge Functions                | 1 dia    |
| P3         | Considerar monorepo formal               | 2-3 dias |

---

## 7. Next Steps

1. **Imediato (hoje):**
   - [ ] `npm prune` para remover lovable-tagger
   - [ ] Regenerar package-lock.json

2. **Curto prazo (esta semana):**
   - [ ] Auditar JWT verification nas Edge Functions
   - [ ] Corrigir testes falhando

3. **Medio prazo:**
   - [ ] Aumentar cobertura de testes (meta: 50%)
   - [ ] Documentar arquitetura das Edge Functions

---

_Generated by @architect (Aria) - arquitetando o futuro_
