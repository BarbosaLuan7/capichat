openapi: 3.0.3
info:
  title: LB ADV CRM API
  version: 3.0.0
  description: |
    API RESTful para integração externa com o **LB ADV CRM** (GaranteDireito).

    Sistema especializado em Direito Previdenciário, com gestão de casos e atendimento via WhatsApp.

    ## Autenticação

    Todas as requisições devem incluir um header de autorização:

    ```
    Authorization: Bearer {seu_token}
    ```

    O token pode ser gerado em **Ajustes > Integrações > API**.

    ## Base URL

    Todas as requisições devem ser feitas para:
    ```
    https://vnsypopnzwtkmyvxvqpu.supabase.co/functions/v1
    ```

    ## Rate Limiting

    | Operação | Limite |
    |----------|--------|
    | Envio de mensagens | 300 req/min |
    | Leitura (GET) | 3000 req/min |
    | Escrita (POST/PUT/DELETE) | 500 req/min |

    ## Paginação

    Endpoints de listagem retornam campos em português e inglês:
    ```json
    {
      "sucesso": true,
      "success": true,
      "dados": [...],
      "data": [...],
      "paginacao": {
        "pagina": 1,
        "por_pagina": 50,
        "total": 150,
        "total_paginas": 3
      },
      "pagination": {
        "page": 1,
        "page_size": 50,
        "total": 150,
        "total_pages": 3
      }
    }
    ```

    ## Identificação de Contatos

    A maioria dos endpoints aceita **UUID** ou **telefone** para identificar contatos:
    - `id=8454ff97-627b-4730-901e-b091ed5e5685` (UUID)
    - `id=5511999990001` (telefone)
    - `lead_id=11999990001` (telefone sem código país)
    - `contato_id=+55 (11) 99999-0001` (telefone formatado)

    O sistema detecta automaticamente se o valor é UUID ou telefone.

  contact:
    name: GaranteDireito Suporte
    email: contato@garantedireito.com.br
  license:
    name: Proprietária

servers:
  - url: https://vnsypopnzwtkmyvxvqpu.supabase.co/functions/v1
    description: Produção (Edge Functions)

security:
  - BearerAuth: []

tags:
  - name: Usuários
    description: Gerenciamento de usuários/atendentes
  - name: Equipes
    description: Gerenciamento de equipes
  - name: Contatos
    description: Gerenciamento de contatos/leads
  - name: Resumo do Caso
    description: Resumo de qualificação do caso (case_summary)
  - name: Etiquetas
    description: Gerenciamento de etiquetas
  - name: Campos Personalizados
    description: Campos customizados
  - name: Carteiras
    description: Agrupamento de contatos
  - name: Webhooks
    description: Configuração de webhooks
  - name: Arquivos
    description: Upload de arquivos
  - name: Conversas
    description: Gerenciamento de conversas
  - name: Mensagens
    description: Envio e recebimento de mensagens
  - name: Mensagens Agendadas
    description: Agendamento de mensagens
  - name: Templates
    description: Modelos de mensagens
  - name: Canais
    description: Canais de atendimento (WhatsApp)
  - name: Chatbots
    description: Fluxos de chatbot
  - name: Oportunidades
    description: Cards/oportunidades no funil
  - name: Funis
    description: Painéis e etapas do funil
  - name: Tarefas
    description: Tarefas e lembretes

paths:
  # ============================================================================
  # USUÁRIOS
  # ============================================================================
  /api-users:
    get:
      tags: [Usuários]
      summary: Listar usuários
      operationId: listarUsuarios
      parameters:
        - name: id
          in: query
          description: ID do usuário (para buscar específico)
          schema:
            type: string
            format: uuid
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            default: 50
        - name: ativo
          in: query
          schema:
            type: boolean
        - name: disponivel
          in: query
          schema:
            type: boolean
        - name: action
          in: query
          description: 'Ações: equipes (GET)'
          schema:
            type: string
            enum: [equipes]
      responses:
        '200':
          description: Lista de usuários ou usuário específico
          content:
            application/json:
              schema:
                type: object
                properties:
                  dados:
                    type: array
                    items:
                      $ref: '#/components/schemas/Usuario'
                  paginacao:
                    $ref: '#/components/schemas/Paginacao'

    post:
      tags: [Usuários]
      summary: Ações em usuário
      operationId: acoesUsuario
      description: |
        Usa o parâmetro `action` para diferentes operações:
        - `equipes`: Atualizar equipes do usuário
        - `status`: Alterar status (ativo/inativo)
        - `disponibilidade`: Alterar disponibilidade
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: action
          in: query
          required: true
          schema:
            type: string
            enum: [equipes, status, disponibilidade]
      requestBody:
        content:
          application/json:
            schema:
              oneOf:
                - type: object
                  properties:
                    equipes:
                      type: array
                      items:
                        type: object
                        properties:
                          equipe_id:
                            type: string
                          supervisor:
                            type: boolean
                - type: object
                  properties:
                    ativo:
                      type: boolean
                - type: object
                  properties:
                    disponivel:
                      type: boolean
      responses:
        '200':
          description: Ação executada

    put:
      tags: [Usuários]
      summary: Atualizar usuário
      operationId: atualizarUsuario
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AtualizarUsuarioRequest'
      responses:
        '200':
          description: Usuário atualizado

    delete:
      tags: [Usuários]
      summary: Desativar usuário
      operationId: desativarUsuario
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Usuário desativado

  # ============================================================================
  # EQUIPES
  # ============================================================================
  /api-teams:
    get:
      tags: [Equipes]
      summary: Listar equipes
      operationId: listarEquipes
      parameters:
        - name: id
          in: query
          description: ID da equipe (para buscar específica)
          schema:
            type: string
            format: uuid
        - name: action
          in: query
          description: 'Ações: canais (GET lista canais da equipe)'
          schema:
            type: string
            enum: [canais]
      responses:
        '200':
          description: Lista de equipes
          content:
            application/json:
              schema:
                type: object
                properties:
                  dados:
                    type: array
                    items:
                      $ref: '#/components/schemas/Equipe'

    post:
      tags: [Equipes]
      summary: Criar equipe
      operationId: criarEquipe
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CriarEquipeRequest'
      responses:
        '201':
          description: Equipe criada

    put:
      tags: [Equipes]
      summary: Atualizar equipe
      operationId: atualizarEquipe
      description: |
        Usa o parâmetro `action` para operações específicas:
        - Sem action: Atualiza dados da equipe
        - `usuarios`: Atualiza membros da equipe
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: action
          in: query
          schema:
            type: string
            enum: [usuarios]
      requestBody:
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/AtualizarEquipeRequest'
                - type: object
                  properties:
                    usuarios:
                      type: array
                      items:
                        type: object
                        properties:
                          usuario_id:
                            type: string
                          supervisor:
                            type: boolean
      responses:
        '200':
          description: Equipe atualizada

    delete:
      tags: [Equipes]
      summary: Remover equipe
      operationId: removerEquipe
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Equipe removida

  # ============================================================================
  # CONTATOS (LEADS)
  # ============================================================================
  /api-leads:
    get:
      tags: [Contatos]
      summary: Listar/buscar contatos
      operationId: listarContatos
      description: |
        O parâmetro `id` aceita UUID ou telefone:
        - `id=8454ff97-627b-4730-901e-b091ed5e5685`
        - `id=5511999990001`
      parameters:
        - name: id
          in: query
          description: ID do contato (UUID ou telefone)
          schema:
            type: string
        - name: phone
          in: query
          description: Buscar por telefone
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Lista de contatos
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Contato'
                  total:
                    type: integer

    post:
      tags: [Contatos]
      summary: Criar contato ou ações
      operationId: criarContato
      description: |
        Sem action: Cria novo contato

        Com action:
        - `lote`: Criar múltiplos contatos
        - `filtro`: Busca avançada com filtros
        - `etiquetas` (com id): Gerenciar etiquetas do contato
      parameters:
        - name: id
          in: query
          description: ID do contato (UUID ou telefone, para action=etiquetas)
          schema:
            type: string
        - name: action
          in: query
          schema:
            type: string
            enum: [lote, filtro, etiquetas]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/CriarContatoRequest'
                - $ref: '#/components/schemas/CriarContatosLoteRequest'
                - $ref: '#/components/schemas/FiltroAvancadoRequest'
                - $ref: '#/components/schemas/GerenciarEtiquetasRequest'
      responses:
        '200':
          description: Sucesso
        '201':
          description: Contato criado

    put:
      tags: [Contatos]
      summary: Atualizar contato
      operationId: atualizarContato
      parameters:
        - name: id
          in: query
          required: true
          description: ID do contato (UUID ou telefone)
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AtualizarContatoRequest'
      responses:
        '200':
          description: Contato atualizado

    delete:
      tags: [Contatos]
      summary: Remover contato
      operationId: removerContato
      parameters:
        - name: id
          in: query
          required: true
          description: ID do contato (UUID ou telefone)
          schema:
            type: string
      responses:
        '200':
          description: Contato removido

  /api-contatos-lote:
    post:
      tags: [Contatos]
      summary: Criar contatos em lote
      operationId: criarContatosLote
      description: Cria múltiplos contatos (máximo 100 por requisição).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [contatos]
              properties:
                contatos:
                  type: array
                  maxItems: 100
                  items:
                    $ref: '#/components/schemas/CriarContatoLoteItem'
      responses:
        '200':
          description: Resultado do lote
          content:
            application/json:
              schema:
                type: object
                properties:
                  sucesso:
                    type: boolean
                  resumo:
                    type: object
                    properties:
                      total:
                        type: integer
                      criados:
                        type: integer
                      duplicados:
                        type: integer
                      erros:
                        type: integer

  # ============================================================================
  # ETIQUETAS
  # ============================================================================
  /api-tags:
    get:
      tags: [Etiquetas]
      summary: Listar etiquetas
      operationId: listarEtiquetas
      parameters:
        - name: id
          in: query
          description: ID da etiqueta (busca específica)
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Lista de etiquetas
          content:
            application/json:
              schema:
                type: object
                properties:
                  dados:
                    type: array
                    items:
                      $ref: '#/components/schemas/Etiqueta'

    post:
      tags: [Etiquetas]
      summary: Criar etiqueta
      operationId: criarEtiqueta
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CriarEtiquetaRequest'
      responses:
        '201':
          description: Etiqueta criada

    put:
      tags: [Etiquetas]
      summary: Atualizar etiqueta
      operationId: atualizarEtiqueta
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AtualizarEtiquetaRequest'
      responses:
        '200':
          description: Etiqueta atualizada

    delete:
      tags: [Etiquetas]
      summary: Remover etiqueta
      operationId: removerEtiqueta
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Etiqueta removida

  # ============================================================================
  # CAMPOS PERSONALIZADOS
  # ============================================================================
  /api-campos-personalizados:
    get:
      tags: [Campos Personalizados]
      summary: Listar campos personalizados
      operationId: listarCamposPersonalizados
      parameters:
        - name: id
          in: query
          schema:
            type: string
            format: uuid
        - name: tenant_id
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Lista de campos
          content:
            application/json:
              schema:
                type: object
                properties:
                  dados:
                    type: array
                    items:
                      $ref: '#/components/schemas/CampoPersonalizado'

    post:
      tags: [Campos Personalizados]
      summary: Criar campo
      operationId: criarCampoPersonalizado
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CriarCampoRequest'
      responses:
        '201':
          description: Campo criado

    put:
      tags: [Campos Personalizados]
      summary: Atualizar campo
      operationId: atualizarCampoPersonalizado
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AtualizarCampoRequest'
      responses:
        '200':
          description: Campo atualizado

    delete:
      tags: [Campos Personalizados]
      summary: Remover campo
      operationId: removerCampoPersonalizado
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Campo removido

  # ============================================================================
  # CARTEIRAS
  # ============================================================================
  /api-carteiras:
    get:
      tags: [Carteiras]
      summary: Listar carteiras
      operationId: listarCarteiras
      parameters:
        - name: id
          in: query
          schema:
            type: string
            format: uuid
        - name: action
          in: query
          description: 'contatos: Lista contatos da carteira'
          schema:
            type: string
            enum: [contatos]
        - name: tenant_id
          in: query
          schema:
            type: string
            format: uuid
        - name: pagina
          in: query
          schema:
            type: integer
            default: 1
        - name: por_pagina
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: Lista de carteiras
          content:
            application/json:
              schema:
                type: object
                properties:
                  dados:
                    type: array
                    items:
                      $ref: '#/components/schemas/Carteira'

    post:
      tags: [Carteiras]
      summary: Criar carteira ou adicionar contato
      operationId: criarCarteira
      description: |
        Sem action: Cria carteira
        Com action=contatos: Adiciona contato à carteira (requer id)
      parameters:
        - name: id
          in: query
          description: ID da carteira (para action=contatos)
          schema:
            type: string
            format: uuid
        - name: action
          in: query
          schema:
            type: string
            enum: [contatos]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/CriarCarteiraRequest'
                - type: object
                  required: [contato_id]
                  properties:
                    contato_id:
                      type: string
                      format: uuid
      responses:
        '201':
          description: Criado

    put:
      tags: [Carteiras]
      summary: Atualizar carteira
      operationId: atualizarCarteira
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AtualizarCarteiraRequest'
      responses:
        '200':
          description: Carteira atualizada

    delete:
      tags: [Carteiras]
      summary: Remover carteira ou contato da carteira
      operationId: removerCarteira
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: action
          in: query
          schema:
            type: string
            enum: [contatos]
        - name: contato_id
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Removido

  # ============================================================================
  # WEBHOOKS
  # ============================================================================
  /api-webhooks:
    get:
      tags: [Webhooks]
      summary: Listar webhooks ou eventos
      operationId: listarWebhooks
      parameters:
        - name: id
          in: query
          schema:
            type: string
            format: uuid
        - name: action
          in: query
          description: 'eventos: Lista eventos disponíveis'
          schema:
            type: string
            enum: [eventos]
      responses:
        '200':
          description: Lista de webhooks
          content:
            application/json:
              schema:
                type: object
                properties:
                  dados:
                    type: array
                    items:
                      $ref: '#/components/schemas/Webhook'

    post:
      tags: [Webhooks]
      summary: Criar webhook
      operationId: criarWebhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CriarWebhookRequest'
      responses:
        '201':
          description: Webhook criado

    put:
      tags: [Webhooks]
      summary: Atualizar webhook
      operationId: atualizarWebhook
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AtualizarWebhookRequest'
      responses:
        '200':
          description: Webhook atualizado

    delete:
      tags: [Webhooks]
      summary: Remover webhook
      operationId: removerWebhook
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Webhook removido

  # ============================================================================
  # ARQUIVOS
  # ============================================================================
  /api-arquivos:
    get:
      tags: [Arquivos]
      summary: Obter URL de upload
      operationId: obterUrlUpload
      parameters:
        - name: nome_arquivo
          in: query
          required: true
          schema:
            type: string
        - name: tipo_mime
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: URL de upload
          content:
            application/json:
              schema:
                type: object
                properties:
                  sucesso:
                    type: boolean
                  upload:
                    type: object
                    properties:
                      url:
                        type: string
                      token:
                        type: string
                      path:
                        type: string
                      expira_em:
                        type: string
                        format: date-time

    post:
      tags: [Arquivos]
      summary: Confirmar upload
      operationId: confirmarUpload
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [path]
              properties:
                path:
                  type: string
                nome_original:
                  type: string
      responses:
        '200':
          description: Upload confirmado

    delete:
      tags: [Arquivos]
      summary: Remover arquivo
      operationId: removerArquivo
      parameters:
        - name: path
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Arquivo removido

  # ============================================================================
  # CONVERSAS
  # ============================================================================
  /api-conversations:
    get:
      tags: [Conversas]
      summary: Listar conversas ou buscar específica
      operationId: listarConversas
      description: |
        O parâmetro `id` e `lead_id` aceitam UUID ou telefone:
        - `id=8454ff97-627b-4730-901e-b091ed5e5685`
        - `id=5511999990001` (busca conversa pelo telefone do lead)
        - `lead_id=11999990001` (telefone sem código país)
      parameters:
        - name: id
          in: query
          description: ID da conversa (UUID) ou telefone do lead
          schema:
            type: string
        - name: action
          in: query
          description: 'notas: Lista notas da conversa'
          schema:
            type: string
            enum: [notas]
        - name: status
          in: query
          schema:
            type: string
            enum: [open, pending, resolved]
        - name: assigned_to
          in: query
          description: Alias para responsavel_id
          schema:
            type: string
            format: uuid
        - name: responsavel_id
          in: query
          description: ID do responsável
          schema:
            type: string
            format: uuid
        - name: lead_id
          in: query
          description: ID do lead (UUID ou telefone)
          schema:
            type: string
        - name: contato_id
          in: query
          description: Alias para lead_id
          schema:
            type: string
        - name: page
          in: query
          description: Alias para pagina
          schema:
            type: integer
            default: 1
        - name: pagina
          in: query
          schema:
            type: integer
            default: 1
        - name: page_size
          in: query
          description: Alias para por_pagina
          schema:
            type: integer
            default: 50
        - name: por_pagina
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: Conversa(s) encontrada(s)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/ConversaDetalhadaResponse'
                  - $ref: '#/components/schemas/ListaConversasResponse'
              examples:
                conversa_unica:
                  summary: Conversa específica (com mensagens)
                  value:
                    sucesso: true
                    success: true
                    conversa:
                      id: '8454ff97-627b-4730-901e-b091ed5e5685'
                      status: 'open'
                      status_pt: 'aberta'
                      nao_lidas: 5
                      unread_count: 5
                      favorita: false
                      is_favorite: false
                      responsavel:
                        id: 'uuid-usuario'
                        nome: 'Maria Advogada'
                        name: 'Maria Advogada'
                        email: 'maria@email.com'
                      instancia_whatsapp:
                        id: 'uuid-instancia'
                        nome: 'WhatsApp Principal'
                        telefone: '+55 (11) 99999-0001'
                        identificador: 'principal'
                        provider: 'waha'
                      ultima_mensagem_em: '2026-01-05T14:30:00Z'
                      criada_em: '2026-01-01T10:00:00Z'
                    lead:
                      id: 'uuid-lead'
                      nome: 'João Silva'
                      name: 'João Silva'
                      telefone: '+55 (11) 99999-0002'
                      phone: '11999990002'
                      email: 'joao@email.com'
                      temperatura: 'morno'
                      temperature: 'warm'
                      etapa_funil:
                        id: 'uuid-etapa'
                        nome: 'Qualificação'
                        cor: '#22c55e'
                      etiquetas:
                        - id: 'uuid-etiqueta'
                          nome: 'BPC Idoso'
                          cor: '#3b82f6'
                      responsavel:
                        id: 'uuid-usuario'
                        nome: 'Maria Advogada'
                    mensagens:
                      - id: 'uuid-msg'
                        type: 'text'
                        content: 'Olá, preciso de ajuda'
                        direction: 'inbound'
                        status: 'delivered'
                        created_at: '2026-01-05T14:30:00Z'
                lista_conversas:
                  summary: Lista de conversas
                  value:
                    sucesso: true
                    success: true
                    dados:
                      - id: 'uuid-conversa'
                        status: 'open'
                        status_pt: 'aberta'
                        nao_lidas: 3
                        ultima_mensagem: 'Preciso de ajuda'
                        lead:
                          id: 'uuid-lead'
                          nome: 'João Silva'
                          telefone: '+55 (11) 99999-0002'
                          temperatura: 'morno'
                    paginacao:
                      pagina: 1
                      por_pagina: 50
                      total: 150
                      total_paginas: 3

    post:
      tags: [Conversas]
      summary: Criar conversa ou adicionar nota
      operationId: criarConversa
      description: |
        Sem action: Cria nova conversa
        Com action=notas: Adiciona nota interna à conversa

        O campo `lead_id`/`contato_id` aceita UUID ou telefone.
      parameters:
        - name: id
          in: query
          description: ID da conversa (UUID ou telefone, para action=notas)
          schema:
            type: string
        - name: action
          in: query
          schema:
            type: string
            enum: [notas]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/CriarConversaRequest'
                - $ref: '#/components/schemas/CriarNotaRequest'
            examples:
              criar_conversa:
                summary: Criar conversa (UUID)
                value:
                  lead_id: '8454ff97-627b-4730-901e-b091ed5e5685'
                  status: 'open'
              criar_conversa_telefone:
                summary: Criar conversa (telefone)
                value:
                  contato_id: '5511999990001'
                  status: 'open'
              adicionar_nota:
                summary: Adicionar nota (action=notas)
                value:
                  conteudo: 'Cliente solicitou documentos'
      responses:
        '201':
          description: Criado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversaCriadaResponse'

    put:
      tags: [Conversas]
      summary: Atualizar conversa
      operationId: atualizarConversa
      description: |
        O parâmetro `id` aceita UUID ou telefone.

        Ações disponíveis:
        - `transferir`: Transfere para usuário ou equipe
        - `atribuir`: Atribui a um usuário
        - `finalizar`: Marca como resolvida
        - `reabrir`: Reabre conversa finalizada
      parameters:
        - name: id
          in: query
          required: true
          description: ID da conversa (UUID ou telefone do lead)
          schema:
            type: string
        - name: action
          in: query
          schema:
            type: string
            enum: [transferir, atribuir, finalizar, reabrir]
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AtualizarConversaRequest'
      responses:
        '200':
          description: Conversa atualizada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversaAtualizadaResponse'

    delete:
      tags: [Conversas]
      summary: Remover conversa
      operationId: removerConversa
      parameters:
        - name: id
          in: query
          required: true
          description: ID da conversa (UUID ou telefone)
          schema:
            type: string
      responses:
        '200':
          description: Conversa removida
          content:
            application/json:
              schema:
                type: object
                properties:
                  sucesso:
                    type: boolean
                  success:
                    type: boolean
                  mensagem:
                    type: string
                  message:
                    type: string

  # ============================================================================
  # MENSAGENS - ENVIO
  # ============================================================================
  /chat-v2-mensagem:
    post:
      tags: [Mensagens]
      summary: Enviar mensagem via WhatsApp
      operationId: enviarMensagem
      description: |
        Endpoint principal para envio de mensagens.

        **Identificação do destinatário:**
        - `contato_id`: Aceita UUID ou telefone
        - `telefone`: Número de telefone (qualquer formato)

        **Tipos de mensagem:**
        - `texto`: Mensagem de texto simples
        - `imagem`: Imagem com URL
        - `audio`: Áudio com URL
        - `video`: Vídeo com URL
        - `documento`: Documento com URL
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EnviarMensagemRequest'
            examples:
              enviar_por_uuid:
                summary: Enviar por UUID
                value:
                  contato_id: '8454ff97-627b-4730-901e-b091ed5e5685'
                  conteudo: 'Olá! Como posso ajudar?'
                  tipo: 'texto'
              enviar_por_telefone:
                summary: Enviar por telefone
                value:
                  contato_id: '5511999990001'
                  conteudo: 'Olá! Como posso ajudar?'
                  tipo: 'texto'
              enviar_imagem:
                summary: Enviar imagem
                value:
                  telefone: '5511999990001'
                  conteudo: 'Confira a imagem'
                  tipo: 'imagem'
                  midia_url: 'https://exemplo.com/imagem.jpg'
      responses:
        '200':
          description: Mensagem enviada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MensagemEnviadaResponse'
              example:
                sucesso: true
                success: true
                request_id: 'req_abc12345'
                mensagem_id: 'uuid-mensagem'
                message_id: 'uuid-mensagem'
                instancia_whatsapp:
                  id: 'uuid-instancia'
                  nome: 'WhatsApp Principal'
                  telefone: '+55 (11) 99999-0001'
                  identificador: 'principal'
                  provider: 'waha'
                whatsapp_instance:
                  id: 'uuid-instancia'
                  name: 'WhatsApp Principal'
                  phone_number: '5511999990001'
                  instance_name: 'principal'
                  provider: 'waha'
                mensagem:
                  id: 'uuid-mensagem'
                  tipo: 'texto'
                  type: 'text'
                  conteudo: 'Olá! Como posso ajudar?'
                  content: 'Olá! Como posso ajudar?'
                  enviada_em: '2026-01-05T14:30:00Z'
                  sent_at: '2026-01-05T14:30:00Z'
                  status: 'enviada'
                  direcao: 'saida'
                  direction: 'outbound'
                lead:
                  id: 'uuid-lead'
                  nome: 'João Silva'
                  name: 'João Silva'
                  telefone: '+55 (11) 99999-0002'
                  phone: '11999990002'
                  email: 'joao@email.com'
                  temperatura: 'morno'
                  temperature: 'warm'
                  etapa_funil:
                    id: 'uuid-etapa'
                    nome: 'Qualificação'
                    name: 'Qualificação'
                    cor: '#22c55e'
                    color: '#22c55e'
                  etiquetas:
                    - id: 'uuid-etiqueta'
                      nome: 'BPC Idoso'
                      name: 'BPC Idoso'
                      cor: '#3b82f6'
                      color: '#3b82f6'
                  responsavel:
                    id: 'uuid-usuario'
                    nome: 'Maria Advogada'
                    name: 'Maria Advogada'
                conversa:
                  id: 'uuid-conversa'
                  status: 'open'
                  status_pt: 'aberta'
                  nao_lidas: 0
                  unread_count: 0

  /api-messages-send:
    post:
      tags: [Mensagens]
      summary: Enviar mensagem (API alternativa)
      operationId: enviarMensagemAlt
      description: |
        Endpoint alternativo para envio de mensagens (em inglês).

        **Identificação do destinatário:**
        - `lead_id`: Aceita UUID ou telefone
        - `phone`: Número de telefone

        **Variáveis de template:**
        O conteúdo da mensagem pode incluir variáveis que serão substituídas:
        - `{{nome}}`: Nome do contato
        - `{{primeiro_nome}}`: Primeiro nome
        - `{{telefone}}`: Telefone formatado
        - `{{data}}`: Data atual
        - `{{hora}}`: Hora atual
        - `{{beneficio}}`: Tipo de benefício
        - `{{cpf}}`: CPF formatado
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendMessageRequest'
            examples:
              enviar_simples:
                summary: Enviar mensagem simples
                value:
                  phone: '5511999990001'
                  message: 'Olá {{primeiro_nome}}! Como posso ajudar?'
              enviar_com_lead:
                summary: Enviar com lead_id (telefone)
                value:
                  lead_id: '11999990001'
                  message: 'Olá! Seu benefício de {{beneficio}} está em andamento.'
      responses:
        '200':
          description: Mensagem enviada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MensagemEnviadaResponse'

  /api-messages-receive:
    post:
      tags: [Mensagens]
      summary: Receber mensagem (webhook)
      operationId: receberMensagem
      description: |
        Endpoint para receber mensagens (geralmente chamado por webhooks de provedores WhatsApp).

        - Cria lead automaticamente se não existir
        - Cria conversa automaticamente se não existir
        - Atualiza contadores de não lidas
        - Dispara webhooks de `message.received`, `lead.created`, `conversation.created`
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReceiveMessageRequest'
            example:
              phone: '5511999990001'
              message: 'Olá, preciso de ajuda com meu benefício'
              type: 'text'
              sender_name: 'João Silva'
              timestamp: '2026-01-05T14:30:00Z'
      responses:
        '201':
          description: Mensagem recebida
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MensagemRecebidaResponse'
              example:
                sucesso: true
                success: true
                request_id: 'req_abc12345'
                mensagem_id: 'uuid-mensagem'
                message_id: 'uuid-mensagem'
                instancia_whatsapp:
                  id: 'uuid-instancia'
                  nome: 'WhatsApp Principal'
                  telefone: '+55 (11) 99999-0001'
                mensagem:
                  id: 'uuid-mensagem'
                  tipo: 'texto'
                  type: 'text'
                  conteudo: 'Olá, preciso de ajuda com meu benefício'
                  content: 'Olá, preciso de ajuda com meu benefício'
                  recebida_em: '2026-01-05T14:30:00Z'
                  received_at: '2026-01-05T14:30:00Z'
                  status: 'entregue'
                  direcao: 'entrada'
                  direction: 'inbound'
                  remetente:
                    tipo: 'lead'
                    id: 'uuid-lead'
                    nome: 'João Silva'
                lead:
                  id: 'uuid-lead'
                  nome: 'João Silva'
                  name: 'João Silva'
                  telefone: '+55 (11) 99999-0001'
                  phone: '11999990001'
                  temperatura: 'morno'
                  temperature: 'warm'
                  is_new: true
                  etapa_funil:
                    id: 'uuid-etapa'
                    nome: 'Novo Lead'
                  etiquetas: []
                conversa:
                  id: 'uuid-conversa'
                  status: 'open'
                  status_pt: 'aberta'
                  nao_lidas: 1
                  unread_count: 1
                  is_new: true
                  nova: true

  # ============================================================================
  # MENSAGENS - BUSCA
  # ============================================================================
  /api-mensagens:
    get:
      tags: [Mensagens]
      summary: Buscar mensagens
      operationId: buscarMensagens
      parameters:
        - name: id
          in: query
          description: ID da mensagem
          schema:
            type: string
            format: uuid
        - name: conversa_id
          in: query
          description: ID da conversa
          schema:
            type: string
            format: uuid
        - name: action
          in: query
          description: 'status: Retorna status de entrega'
          schema:
            type: string
            enum: [status]
        - name: pagina
          in: query
          schema:
            type: integer
            default: 1
        - name: por_pagina
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: Mensagem(ns) encontrada(s)
          content:
            application/json:
              schema:
                type: object
                properties:
                  dados:
                    type: array
                    items:
                      $ref: '#/components/schemas/Mensagem'
                  paginacao:
                    $ref: '#/components/schemas/Paginacao'

    delete:
      tags: [Mensagens]
      summary: Apagar mensagem
      operationId: apagarMensagem
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Mensagem apagada

  # ============================================================================
  # MENSAGENS AGENDADAS
  # ============================================================================
  /api-mensagens-agendadas:
    get:
      tags: [Mensagens Agendadas]
      summary: Listar mensagens agendadas
      operationId: listarMensagensAgendadas
      parameters:
        - name: id
          in: query
          schema:
            type: string
            format: uuid
        - name: contato_id
          in: query
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, sent, cancelled, failed]
        - name: pagina
          in: query
          schema:
            type: integer
            default: 1
        - name: por_pagina
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: Lista de mensagens agendadas
          content:
            application/json:
              schema:
                type: object
                properties:
                  dados:
                    type: array
                    items:
                      $ref: '#/components/schemas/MensagemAgendada'
                  paginacao:
                    $ref: '#/components/schemas/Paginacao'

    post:
      tags: [Mensagens Agendadas]
      summary: Agendar mensagem ou cancelar
      operationId: agendarMensagem
      parameters:
        - name: id
          in: query
          description: ID da mensagem (para action=cancelar)
          schema:
            type: string
            format: uuid
        - name: action
          in: query
          schema:
            type: string
            enum: [cancelar]
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgendarMensagemRequest'
      responses:
        '201':
          description: Mensagem agendada

    put:
      tags: [Mensagens Agendadas]
      summary: Atualizar mensagem agendada
      operationId: atualizarMensagemAgendada
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                conteudo:
                  type: string
                agendar_para:
                  type: string
                  format: date-time
      responses:
        '200':
          description: Mensagem atualizada

  # ============================================================================
  # TEMPLATES
  # ============================================================================
  /api-templates:
    get:
      tags: [Templates]
      summary: Listar templates
      operationId: listarTemplates
      parameters:
        - name: id
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Lista de templates
          content:
            application/json:
              schema:
                type: object
                properties:
                  dados:
                    type: array
                    items:
                      $ref: '#/components/schemas/Template'

    post:
      tags: [Templates]
      summary: Criar template
      operationId: criarTemplate
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CriarTemplateRequest'
      responses:
        '201':
          description: Template criado

    put:
      tags: [Templates]
      summary: Atualizar template
      operationId: atualizarTemplate
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AtualizarTemplateRequest'
      responses:
        '200':
          description: Template atualizado

    delete:
      tags: [Templates]
      summary: Remover template
      operationId: removerTemplate
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Template removido

  # ============================================================================
  # CANAIS
  # ============================================================================
  /api-whatsapp-instances:
    get:
      tags: [Canais]
      summary: Listar canais WhatsApp
      operationId: listarCanais
      parameters:
        - name: id
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Lista de canais
          content:
            application/json:
              schema:
                type: object
                properties:
                  dados:
                    type: array
                    items:
                      $ref: '#/components/schemas/Canal'

  # ============================================================================
  # CHATBOTS
  # ============================================================================
  /api-chatbots:
    get:
      tags: [Chatbots]
      summary: Listar chatbots
      operationId: listarChatbots
      parameters:
        - name: id
          in: query
          schema:
            type: string
            format: uuid
        - name: ativo
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: Lista de chatbots
          content:
            application/json:
              schema:
                type: object
                properties:
                  dados:
                    type: array
                    items:
                      $ref: '#/components/schemas/Chatbot'

    post:
      tags: [Chatbots]
      summary: Criar chatbot ou iniciar fluxo
      operationId: criarChatbot
      parameters:
        - name: action
          in: query
          schema:
            type: string
            enum: [enviar]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/CriarChatbotRequest'
                - type: object
                  required: [chatbot_id, contato_id]
                  properties:
                    chatbot_id:
                      type: string
                      format: uuid
                    contato_id:
                      type: string
                      format: uuid
      responses:
        '201':
          description: Criado

    put:
      tags: [Chatbots]
      summary: Atualizar chatbot
      operationId: atualizarChatbot
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AtualizarChatbotRequest'
      responses:
        '200':
          description: Chatbot atualizado

    delete:
      tags: [Chatbots]
      summary: Remover chatbot
      operationId: removerChatbot
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Chatbot removido

  # ============================================================================
  # OPORTUNIDADES
  # ============================================================================
  /api-oportunidades:
    get:
      tags: [Oportunidades]
      summary: Listar oportunidades
      operationId: listarOportunidades
      parameters:
        - name: id
          in: query
          schema:
            type: string
            format: uuid
        - name: action
          in: query
          description: 'notas: Lista notas da oportunidade'
          schema:
            type: string
            enum: [notas]
        - name: etapa_id
          in: query
          schema:
            type: string
            format: uuid
        - name: responsavel_id
          in: query
          schema:
            type: string
            format: uuid
        - name: temperatura
          in: query
          schema:
            type: string
            enum: [cold, warm, hot]
        - name: pagina
          in: query
          schema:
            type: integer
            default: 1
        - name: por_pagina
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: Lista de oportunidades
          content:
            application/json:
              schema:
                type: object
                properties:
                  dados:
                    type: array
                    items:
                      $ref: '#/components/schemas/Oportunidade'
                  paginacao:
                    $ref: '#/components/schemas/Paginacao'

    post:
      tags: [Oportunidades]
      summary: Criar oportunidade ou ações
      operationId: criarOportunidade
      parameters:
        - name: id
          in: query
          description: ID da oportunidade (para duplicar/notas)
          schema:
            type: string
            format: uuid
        - name: action
          in: query
          schema:
            type: string
            enum: [duplicar, notas]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/CriarOportunidadeRequest'
                - type: object
                  required: [conteudo]
                  properties:
                    conteudo:
                      type: string
      responses:
        '201':
          description: Criado

    put:
      tags: [Oportunidades]
      summary: Atualizar oportunidade
      operationId: atualizarOportunidade
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: action
          in: query
          schema:
            type: string
            enum: [mover]
      requestBody:
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/AtualizarOportunidadeRequest'
                - type: object
                  required: [etapa_id]
                  properties:
                    etapa_id:
                      type: string
                      format: uuid
                    ordem:
                      type: integer
      responses:
        '200':
          description: Oportunidade atualizada

    delete:
      tags: [Oportunidades]
      summary: Remover oportunidade
      operationId: removerOportunidade
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Oportunidade removida

  # ============================================================================
  # FUNIS
  # ============================================================================
  /api-funnels:
    get:
      tags: [Funis]
      summary: Listar funis
      operationId: listarFunis
      parameters:
        - name: id
          in: query
          description: ID do funil (busca específico)
          schema:
            type: string
        - name: action
          in: query
          description: 'campos-personalizados: Retorna campos do funil'
          schema:
            type: string
            enum: [campos-personalizados]
        - name: tenant_id
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Lista de funis
          content:
            application/json:
              schema:
                type: object
                properties:
                  dados:
                    type: array
                    items:
                      $ref: '#/components/schemas/Funil'

  # ============================================================================
  # TAREFAS
  # ============================================================================
  /api-tasks:
    get:
      tags: [Tarefas]
      summary: Listar tarefas
      operationId: listarTarefas
      parameters:
        - name: id
          in: query
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          schema:
            type: string
            enum: [todo, in_progress, done]
        - name: responsavel_id
          in: query
          schema:
            type: string
            format: uuid
        - name: contato_id
          in: query
          schema:
            type: string
            format: uuid
        - name: pagina
          in: query
          schema:
            type: integer
            default: 1
        - name: por_pagina
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: Lista de tarefas
          content:
            application/json:
              schema:
                type: object
                properties:
                  dados:
                    type: array
                    items:
                      $ref: '#/components/schemas/Tarefa'
                  paginacao:
                    $ref: '#/components/schemas/Paginacao'

    post:
      tags: [Tarefas]
      summary: Criar tarefa
      operationId: criarTarefa
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CriarTarefaRequest'
      responses:
        '201':
          description: Tarefa criada

    put:
      tags: [Tarefas]
      summary: Atualizar tarefa
      operationId: atualizarTarefa
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AtualizarTarefaRequest'
      responses:
        '200':
          description: Tarefa atualizada

    delete:
      tags: [Tarefas]
      summary: Remover tarefa
      operationId: removerTarefa
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Tarefa removida

  # ============================================================================
  # RESUMO DO CASO (LEAD SUMMARY)
  # ============================================================================
  /api-lead-summary:
    get:
      tags: [Resumo do Caso]
      summary: Obter resumo do caso
      operationId: obterResumoCaso
      description: |
        Retorna o resumo de qualificação do caso.

        Identifique o contato por `lead_id` OU `phone` (aceita UUID ou telefone).
      parameters:
        - name: lead_id
          in: query
          description: ID do contato (UUID ou telefone)
          schema:
            type: string
        - name: phone
          in: query
          description: Telefone do contato
          schema:
            type: string
      responses:
        '200':
          description: Resumo do caso
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      lead_id:
                        type: string
                      lead_name:
                        type: string
                      case_summary:
                        type: string

    put:
      tags: [Resumo do Caso]
      summary: Atualizar resumo do caso
      operationId: atualizarResumoCaso
      parameters:
        - name: lead_id
          in: query
          description: ID do contato (UUID ou telefone)
          schema:
            type: string
        - name: phone
          in: query
          description: Telefone do contato
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [summary]
              properties:
                summary:
                  type: string
                  description: Resumo formatado do caso
      responses:
        '200':
          description: Resumo atualizado

    delete:
      tags: [Resumo do Caso]
      summary: Remover resumo do caso
      operationId: removerResumoCaso
      parameters:
        - name: lead_id
          in: query
          description: ID do contato (UUID ou telefone)
          schema:
            type: string
        - name: phone
          in: query
          description: Telefone do contato
          schema:
            type: string
      responses:
        '200':
          description: Resumo removido

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: API Key gerada no sistema

  schemas:
    # ============================================================================
    # SCHEMAS COMUNS
    # ============================================================================
    Paginacao:
      type: object
      properties:
        pagina:
          type: integer
        por_pagina:
          type: integer
        total:
          type: integer
        total_paginas:
          type: integer

    PaginationEN:
      type: object
      properties:
        page:
          type: integer
        page_size:
          type: integer
        total:
          type: integer
        total_pages:
          type: integer

    InstanciaWhatsApp:
      type: object
      description: Dados da instância WhatsApp (bilíngue)
      properties:
        id:
          type: string
        nome:
          type: string
        name:
          type: string
        telefone:
          type: string
          description: Telefone formatado (+55 (11) 99999-0001)
        phone_number:
          type: string
          description: Telefone raw (5511999990001)
        identificador:
          type: string
        instance_name:
          type: string
        provider:
          type: string
          enum: [waha, evolution, z-api, custom]

    EtapaFunil:
      type: object
      description: Etapa do funil (bilíngue)
      properties:
        id:
          type: string
        nome:
          type: string
        name:
          type: string
        cor:
          type: string
        color:
          type: string

    Responsavel:
      type: object
      description: Usuário responsável (bilíngue)
      properties:
        id:
          type: string
        nome:
          type: string
        name:
          type: string
        email:
          type: string

    EtiquetaCompleta:
      type: object
      description: Etiqueta com dados completos (bilíngue)
      properties:
        id:
          type: string
        nome:
          type: string
        name:
          type: string
        cor:
          type: string
        color:
          type: string
        categoria:
          type: string
        category:
          type: string

    LeadCompleto:
      type: object
      description: Dados completos do lead/contato (bilíngue)
      properties:
        id:
          type: string
        nome:
          type: string
        name:
          type: string
        telefone:
          type: string
          description: Telefone formatado
        phone:
          type: string
          description: Telefone raw
        email:
          type: string
        cpf:
          type: string
        temperatura:
          type: string
          enum: [frio, morno, quente]
        temperature:
          type: string
          enum: [cold, warm, hot]
        etapa_funil:
          $ref: '#/components/schemas/EtapaFunil'
        funnel_stage:
          $ref: '#/components/schemas/EtapaFunil'
        etiquetas:
          type: array
          items:
            $ref: '#/components/schemas/EtiquetaCompleta'
        labels:
          type: array
          items:
            $ref: '#/components/schemas/EtiquetaCompleta'
        responsavel:
          $ref: '#/components/schemas/Responsavel'
        assigned_to:
          $ref: '#/components/schemas/Responsavel'
        origem:
          type: string
        source:
          type: string
        tipo_beneficio:
          type: string
        benefit_type:
          type: string
        avatar_url:
          type: string
        is_new:
          type: boolean
          description: true se o lead foi criado nesta operação
        criado_em:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time

    ConversaCompleta:
      type: object
      description: Dados completos da conversa (bilíngue)
      properties:
        id:
          type: string
        status:
          type: string
          enum: [open, pending, resolved]
        status_pt:
          type: string
          enum: [aberta, pendente, finalizada]
        nao_lidas:
          type: integer
        unread_count:
          type: integer
        favorita:
          type: boolean
        is_favorite:
          type: boolean
        is_new:
          type: boolean
          description: true se a conversa foi criada nesta operação
        nova:
          type: boolean
        responsavel:
          $ref: '#/components/schemas/Responsavel'
        assigned_to:
          $ref: '#/components/schemas/Responsavel'
        instancia_whatsapp:
          $ref: '#/components/schemas/InstanciaWhatsApp'
        whatsapp_instance:
          $ref: '#/components/schemas/InstanciaWhatsApp'
        ultima_mensagem_em:
          type: string
          format: date-time
        last_message_at:
          type: string
          format: date-time
        ultima_mensagem:
          type: string
        last_message_content:
          type: string
        criada_em:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time

    MensagemCompleta:
      type: object
      description: Dados completos da mensagem (bilíngue)
      properties:
        id:
          type: string
        tipo:
          type: string
          enum: [texto, imagem, audio, video, documento]
        type:
          type: string
          enum: [text, image, audio, video, document]
        conteudo:
          type: string
        content:
          type: string
        midia_url:
          type: string
        media_url:
          type: string
        enviada_em:
          type: string
          format: date-time
        sent_at:
          type: string
          format: date-time
        recebida_em:
          type: string
          format: date-time
        received_at:
          type: string
          format: date-time
        status:
          type: string
        direcao:
          type: string
          enum: [entrada, saida]
        direction:
          type: string
          enum: [inbound, outbound]
        remetente:
          type: object
          properties:
            tipo:
              type: string
              enum: [lead, sistema]
            type:
              type: string
              enum: [lead, system]
            id:
              type: string
            nome:
              type: string
            name:
              type: string

    # ============================================================================
    # RESPONSES DE CONVERSAS
    # ============================================================================
    ConversaDetalhadaResponse:
      type: object
      properties:
        sucesso:
          type: boolean
        success:
          type: boolean
        conversa:
          $ref: '#/components/schemas/ConversaCompleta'
        conversation:
          $ref: '#/components/schemas/ConversaCompleta'
        lead:
          $ref: '#/components/schemas/LeadCompleto'
        contato:
          $ref: '#/components/schemas/LeadCompleto'
        mensagens:
          type: array
          items:
            $ref: '#/components/schemas/Mensagem'
        messages:
          type: array
          items:
            $ref: '#/components/schemas/Mensagem'

    ListaConversasResponse:
      type: object
      properties:
        sucesso:
          type: boolean
        success:
          type: boolean
        dados:
          type: array
          items:
            $ref: '#/components/schemas/ConversaResumo'
        data:
          type: array
          items:
            $ref: '#/components/schemas/ConversaResumo'
        paginacao:
          $ref: '#/components/schemas/Paginacao'
        pagination:
          $ref: '#/components/schemas/PaginationEN'

    ConversaResumo:
      type: object
      properties:
        id:
          type: string
        status:
          type: string
        status_pt:
          type: string
        nao_lidas:
          type: integer
        unread_count:
          type: integer
        favorita:
          type: boolean
        is_favorite:
          type: boolean
        ultima_mensagem_em:
          type: string
          format: date-time
        last_message_at:
          type: string
          format: date-time
        ultima_mensagem:
          type: string
        last_message_content:
          type: string
        lead:
          type: object
          properties:
            id:
              type: string
            nome:
              type: string
            name:
              type: string
            telefone:
              type: string
            phone:
              type: string
            avatar_url:
              type: string
            temperatura:
              type: string
            temperature:
              type: string
        contato:
          type: object
          properties:
            id:
              type: string
            nome:
              type: string
            telefone:
              type: string
            avatar_url:
              type: string
            temperatura:
              type: string
        criada_em:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time

    ConversaCriadaResponse:
      type: object
      properties:
        sucesso:
          type: boolean
        success:
          type: boolean
        conversa:
          type: object
          properties:
            id:
              type: string
            status:
              type: string
            status_pt:
              type: string
            criada_em:
              type: string
              format: date-time
            created_at:
              type: string
              format: date-time
        conversation:
          type: object
          properties:
            id:
              type: string
            status:
              type: string
            created_at:
              type: string
              format: date-time
        lead:
          $ref: '#/components/schemas/LeadCompleto'
        contato:
          $ref: '#/components/schemas/LeadCompleto'

    ConversaAtualizadaResponse:
      type: object
      properties:
        sucesso:
          type: boolean
        success:
          type: boolean
        acao:
          type: string
          enum: [transferir, atribuir, finalizar, reabrir, atualizar]
        action:
          type: string
          enum: [transfer, assign, resolve, reopen, update]
        conversa:
          type: object
          properties:
            id:
              type: string
            status:
              type: string
            status_pt:
              type: string
            atualizada_em:
              type: string
              format: date-time
        conversation:
          type: object
          properties:
            id:
              type: string
            status:
              type: string
            updated_at:
              type: string
              format: date-time
        transferido_para:
          type: object
          properties:
            tipo:
              type: string
              enum: [usuario, equipe]
            id:
              type: string
        transferred_to:
          type: object
          properties:
            tipo:
              type: string
            id:
              type: string
        lead:
          $ref: '#/components/schemas/LeadCompleto'
        contato:
          $ref: '#/components/schemas/LeadCompleto'

    # ============================================================================
    # RESPONSES DE MENSAGENS
    # ============================================================================
    MensagemEnviadaResponse:
      type: object
      properties:
        sucesso:
          type: boolean
        success:
          type: boolean
        request_id:
          type: string
          description: ID único da requisição
        mensagem_id:
          type: string
        message_id:
          type: string
        external_message_id:
          type: string
          description: ID da mensagem no provedor WhatsApp
        instancia_whatsapp:
          $ref: '#/components/schemas/InstanciaWhatsApp'
        whatsapp_instance:
          $ref: '#/components/schemas/InstanciaWhatsApp'
        mensagem:
          $ref: '#/components/schemas/MensagemCompleta'
        message:
          $ref: '#/components/schemas/MensagemCompleta'
        lead:
          $ref: '#/components/schemas/LeadCompleto'
        contato:
          $ref: '#/components/schemas/LeadCompleto'
        conversa:
          $ref: '#/components/schemas/ConversaCompleta'
        conversation:
          $ref: '#/components/schemas/ConversaCompleta'

    MensagemRecebidaResponse:
      type: object
      properties:
        sucesso:
          type: boolean
        success:
          type: boolean
        request_id:
          type: string
        mensagem_id:
          type: string
        message_id:
          type: string
        instancia_whatsapp:
          $ref: '#/components/schemas/InstanciaWhatsApp'
        whatsapp_instance:
          $ref: '#/components/schemas/InstanciaWhatsApp'
        mensagem:
          $ref: '#/components/schemas/MensagemCompleta'
        message:
          $ref: '#/components/schemas/MensagemCompleta'
        lead:
          $ref: '#/components/schemas/LeadCompleto'
        contato:
          $ref: '#/components/schemas/LeadCompleto'
        conversa:
          $ref: '#/components/schemas/ConversaCompleta'
        conversation:
          $ref: '#/components/schemas/ConversaCompleta'

    # ============================================================================
    # REQUESTS
    # ============================================================================
    CriarConversaRequest:
      type: object
      required: [lead_id]
      properties:
        lead_id:
          type: string
          description: ID do lead (UUID ou telefone)
        contato_id:
          type: string
          description: Alias para lead_id (UUID ou telefone)
        assigned_to:
          type: string
          format: uuid
        responsavel_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [open, pending, resolved]
          default: open
        whatsapp_instance_id:
          type: string
          format: uuid
        instancia_id:
          type: string
          format: uuid

    CriarNotaRequest:
      type: object
      required: [conteudo]
      properties:
        conteudo:
          type: string
        content:
          type: string
        author_id:
          type: string
          format: uuid

    AtualizarConversaRequest:
      type: object
      properties:
        status:
          type: string
          enum: [open, pending, resolved]
        assigned_to:
          type: string
          format: uuid
        responsavel_id:
          type: string
          format: uuid
        usuario_id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        is_favorite:
          type: boolean
        favorito:
          type: boolean
        tipo:
          type: string
          enum: [usuario, equipe]
          description: Para action=transferir
        equipe_id:
          type: string
          format: uuid
          description: Para action=transferir com tipo=equipe

    EnviarMensagemRequest:
      type: object
      required: [conteudo]
      description: |
        O campo `contato_id` aceita UUID ou telefone.
      properties:
        contato_id:
          type: string
          description: ID do contato (UUID ou telefone)
        telefone:
          type: string
          description: Número de telefone (alternativo ao contato_id)
        tipo:
          type: string
          enum: [texto, imagem, audio, video, documento]
          default: texto
        conteudo:
          type: string
        midia_url:
          type: string
        instancia_id:
          type: string
          format: uuid
          description: ID da instância WhatsApp a usar

    SendMessageRequest:
      type: object
      required: [phone, message]
      description: |
        O campo `lead_id` aceita UUID ou telefone.
      properties:
        phone:
          type: string
          description: Número de telefone do destinatário
        message:
          type: string
          description: Conteúdo da mensagem (suporta variáveis de template)
        type:
          type: string
          enum: [text, image, audio, video, document]
          default: text
        media_url:
          type: string
        lead_id:
          type: string
          description: ID do lead (UUID ou telefone)
        conversation_id:
          type: string
          format: uuid
        whatsapp_instance_id:
          type: string
          format: uuid

    ReceiveMessageRequest:
      type: object
      required: [phone, message]
      properties:
        phone:
          type: string
          description: Número de telefone do remetente
        country_code:
          type: string
          description: Código do país (55, 1, etc)
        message:
          type: string
        type:
          type: string
          enum: [text, image, audio, video, document]
          default: text
        media_url:
          type: string
        timestamp:
          type: string
          format: date-time
        external_id:
          type: string
          description: ID da mensagem no provedor WhatsApp
        sender_name:
          type: string
          description: Nome do remetente (do WhatsApp)
        whatsapp_instance_id:
          type: string
          format: uuid

    # ============================================================================
    # SCHEMAS EXISTENTES (mantidos)
    # ============================================================================
    Usuario:
      type: object
      properties:
        id:
          type: string
        nome:
          type: string
        email:
          type: string
        telefone:
          type: string
        avatar_url:
          type: string
        cargo:
          type: string
          enum: [administrador, gerente, atendente, visualizador]
        ativo:
          type: boolean
        disponivel:
          type: boolean
        equipes:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              nome:
                type: string
              supervisor:
                type: boolean
        criado_em:
          type: string
          format: date-time

    AtualizarUsuarioRequest:
      type: object
      properties:
        nome:
          type: string
        telefone:
          type: string
        disponivel:
          type: boolean

    Equipe:
      type: object
      properties:
        id:
          type: string
        nome:
          type: string
        nivel_acesso:
          type: string
          enum: [todos, equipe, atendente]
        distribuicao_automatica:
          type: boolean
        equipe_padrao:
          type: boolean
        total_membros:
          type: integer
        criado_em:
          type: string
          format: date-time

    CriarEquipeRequest:
      type: object
      required: [nome]
      properties:
        nome:
          type: string
        nivel_acesso:
          type: string
          enum: [todos, equipe, atendente]
        distribuicao_automatica:
          type: boolean

    AtualizarEquipeRequest:
      type: object
      properties:
        nome:
          type: string
        nivel_acesso:
          type: string
        distribuicao_automatica:
          type: boolean

    Contato:
      type: object
      properties:
        id:
          type: string
        nome:
          type: string
        telefone:
          type: string
        codigo_pais:
          type: string
        email:
          type: string
        cpf:
          type: string
        avatar_url:
          type: string
        etapa_id:
          type: string
        temperatura:
          type: string
          enum: [cold, warm, hot]
        responsavel_id:
          type: string
        tipo_beneficio:
          type: string
        etiquetas:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              nome:
                type: string
              cor:
                type: string
        criado_em:
          type: string
          format: date-time

    CriarContatoRequest:
      type: object
      required: [name, phone]
      properties:
        name:
          type: string
        phone:
          type: string
        country_code:
          type: string
        email:
          type: string
        cpf:
          type: string
        birth_date:
          type: string
          format: date
        benefit_type:
          type: string
        nit_pis:
          type: string
        source:
          type: string
        stage_id:
          type: string
          format: uuid
        assigned_to:
          type: string
          format: uuid
        temperature:
          type: string
          enum: [cold, warm, hot]
        custom_fields:
          type: object
        tenant_id:
          type: string
          format: uuid

    CriarContatosLoteRequest:
      type: object
      required: [contatos]
      properties:
        contatos:
          type: array
          maxItems: 100
          items:
            type: object
            required: [name, phone]
            properties:
              name:
                type: string
              phone:
                type: string
              email:
                type: string
              source:
                type: string
              temperature:
                type: string
                enum: [cold, warm, hot]

    FiltroAvancadoRequest:
      type: object
      properties:
        etiquetas:
          type: array
          items:
            type: string
            format: uuid
        campos:
          type: object
        periodo:
          type: object
          properties:
            inicio:
              type: string
              format: date
            fim:
              type: string
              format: date
        temperatura:
          type: string
          enum: [cold, warm, hot]
        etapa_funil:
          type: string
        responsavel:
          type: string
        tenant_id:
          type: string
          format: uuid
        pagina:
          type: integer
          default: 1
        por_pagina:
          type: integer
          default: 50

    GerenciarEtiquetasRequest:
      type: object
      properties:
        adicionar:
          type: array
          items:
            type: string
            format: uuid
        remover:
          type: array
          items:
            type: string
            format: uuid

    CriarContatoLoteItem:
      type: object
      required: [nome, telefone]
      properties:
        nome:
          type: string
        telefone:
          type: string
        codigo_pais:
          type: string
        email:
          type: string
        cpf:
          type: string
        tipo_beneficio:
          type: string
        origem:
          type: string
        etiquetas:
          type: array
          items:
            type: string
            format: uuid

    AtualizarContatoRequest:
      type: object
      properties:
        name:
          type: string
        phone:
          type: string
        email:
          type: string
        stage_id:
          type: string
          format: uuid
        temperature:
          type: string
          enum: [cold, warm, hot]
        assigned_to:
          type: string
          format: uuid

    Etiqueta:
      type: object
      properties:
        id:
          type: string
        nome:
          type: string
        cor:
          type: string
        categoria:
          type: string
          enum:
            [
              origem,
              interesse,
              prioridade,
              status,
              beneficio,
              condicao_saude,
              desqualificacao,
              situacao,
              perda,
            ]

    CriarEtiquetaRequest:
      type: object
      required: [nome]
      properties:
        nome:
          type: string
        cor:
          type: string
        categoria:
          type: string

    AtualizarEtiquetaRequest:
      type: object
      properties:
        nome:
          type: string
        cor:
          type: string

    CampoPersonalizado:
      type: object
      properties:
        id:
          type: string
        nome:
          type: string
        rotulo:
          type: string
        tipo:
          type: string
          enum: [texto, numero, data, selecao, selecao_multipla, booleano]
        opcoes:
          type: array
          items:
            type: string
        obrigatorio:
          type: boolean
        ordem:
          type: integer
        ativo:
          type: boolean

    CriarCampoRequest:
      type: object
      required: [nome, rotulo]
      properties:
        nome:
          type: string
        rotulo:
          type: string
        tipo:
          type: string
          enum: [texto, numero, data, selecao, selecao_multipla, booleano]
        opcoes:
          type: array
          items:
            type: string
        obrigatorio:
          type: boolean
        ordem:
          type: integer

    AtualizarCampoRequest:
      type: object
      properties:
        nome:
          type: string
        rotulo:
          type: string
        tipo:
          type: string
        opcoes:
          type: array
          items:
            type: string
        obrigatorio:
          type: boolean
        ordem:
          type: integer

    Carteira:
      type: object
      properties:
        id:
          type: string
        nome:
          type: string
        descricao:
          type: string
        cor:
          type: string
        total_contatos:
          type: integer
        criada_em:
          type: string
          format: date-time

    CriarCarteiraRequest:
      type: object
      required: [nome]
      properties:
        nome:
          type: string
        descricao:
          type: string
        cor:
          type: string

    AtualizarCarteiraRequest:
      type: object
      properties:
        nome:
          type: string
        descricao:
          type: string
        cor:
          type: string

    Webhook:
      type: object
      properties:
        id:
          type: string
        nome:
          type: string
        url:
          type: string
        eventos:
          type: array
          items:
            type: string
        ativo:
          type: boolean
        criado_em:
          type: string
          format: date-time

    CriarWebhookRequest:
      type: object
      required: [nome, url, eventos]
      properties:
        nome:
          type: string
        url:
          type: string
        eventos:
          type: array
          items:
            type: string
        headers:
          type: object

    AtualizarWebhookRequest:
      type: object
      properties:
        nome:
          type: string
        url:
          type: string
        eventos:
          type: array
          items:
            type: string
        ativo:
          type: boolean

    Conversa:
      type: object
      properties:
        id:
          type: string
        lead_id:
          type: string
        status:
          type: string
          enum: [open, pending, resolved]
        assigned_to:
          type: string
        unread_count:
          type: integer
        last_message_at:
          type: string
          format: date-time
        last_message_content:
          type: string
        is_favorite:
          type: boolean
        created_at:
          type: string
          format: date-time

    Mensagem:
      type: object
      properties:
        id:
          type: string
        conversation_id:
          type: string
        type:
          type: string
          enum: [text, image, audio, video, document]
        content:
          type: string
        sender_type:
          type: string
          enum: [lead, agent]
        sender_id:
          type: string
        direction:
          type: string
          enum: [inbound, outbound]
        status:
          type: string
          enum: [sent, delivered, read]
        media_url:
          type: string
        created_at:
          type: string
          format: date-time

    MensagemAgendada:
      type: object
      properties:
        id:
          type: string
        contato_id:
          type: string
        conversa_id:
          type: string
        conteudo:
          type: string
        agendado_para:
          type: string
          format: date-time
        status:
          type: string
          enum: [pending, sent, cancelled, failed]
        enviado_em:
          type: string
          format: date-time
        criado_em:
          type: string
          format: date-time

    AgendarMensagemRequest:
      type: object
      required: [contato_id, conteudo, agendar_para]
      properties:
        contato_id:
          type: string
          format: uuid
        conversa_id:
          type: string
          format: uuid
        conteudo:
          type: string
        agendar_para:
          type: string
          format: date-time
        template_id:
          type: string
          format: uuid

    Template:
      type: object
      properties:
        id:
          type: string
        nome:
          type: string
        atalho:
          type: string
        conteudo:
          type: string
        criado_em:
          type: string
          format: date-time

    CriarTemplateRequest:
      type: object
      required: [nome, atalho, conteudo]
      properties:
        nome:
          type: string
        atalho:
          type: string
        conteudo:
          type: string

    AtualizarTemplateRequest:
      type: object
      properties:
        nome:
          type: string
        atalho:
          type: string
        conteudo:
          type: string

    Canal:
      type: object
      properties:
        id:
          type: string
        nome:
          type: string
        tipo:
          type: string
          enum: [whatsapp]
        telefone:
          type: string
        ativo:
          type: boolean
        criado_em:
          type: string
          format: date-time

    Chatbot:
      type: object
      properties:
        id:
          type: string
        nome:
          type: string
        descricao:
          type: string
        ativo:
          type: boolean
        nodes:
          type: array
          items:
            type: object
        connections:
          type: array
          items:
            type: object
        criado_em:
          type: string
          format: date-time

    CriarChatbotRequest:
      type: object
      required: [nome]
      properties:
        nome:
          type: string
        descricao:
          type: string
        nodes:
          type: array
          items:
            type: object
        connections:
          type: array
          items:
            type: object
        ativo:
          type: boolean

    AtualizarChatbotRequest:
      type: object
      properties:
        nome:
          type: string
        descricao:
          type: string
        nodes:
          type: array
          items:
            type: object
        connections:
          type: array
          items:
            type: object
        ativo:
          type: boolean

    Oportunidade:
      type: object
      properties:
        id:
          type: string
        nome:
          type: string
        telefone:
          type: string
        email:
          type: string
        etapa_id:
          type: string
        etapa:
          type: object
          properties:
            id:
              type: string
            nome:
              type: string
            cor:
              type: string
        temperatura:
          type: string
          enum: [cold, warm, hot]
        responsavel_id:
          type: string
        valor_estimado:
          type: number
        tipo_beneficio:
          type: string
        etiquetas:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              nome:
                type: string
              cor:
                type: string
        criado_em:
          type: string
          format: date-time

    CriarOportunidadeRequest:
      type: object
      required: [nome, telefone]
      properties:
        nome:
          type: string
        telefone:
          type: string
        email:
          type: string
        etapa_id:
          type: string
          format: uuid
        responsavel_id:
          type: string
          format: uuid
        temperatura:
          type: string
          enum: [cold, warm, hot]
        valor_estimado:
          type: number
        tipo_beneficio:
          type: string
        origem:
          type: string

    AtualizarOportunidadeRequest:
      type: object
      properties:
        nome:
          type: string
        telefone:
          type: string
        email:
          type: string
        etapa_id:
          type: string
          format: uuid
        responsavel_id:
          type: string
          format: uuid
        temperatura:
          type: string
          enum: [cold, warm, hot]
        valor_estimado:
          type: number
        tipo_beneficio:
          type: string

    Funil:
      type: object
      properties:
        id:
          type: string
        nome:
          type: string
        total_etapas:
          type: integer
        total_oportunidades:
          type: integer
        etapas:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              nome:
                type: string
              ordem:
                type: integer
              cor:
                type: string
              total:
                type: integer

    Tarefa:
      type: object
      properties:
        id:
          type: string
        titulo:
          type: string
        descricao:
          type: string
        status:
          type: string
          enum: [todo, in_progress, done]
        prioridade:
          type: string
          enum: [urgent, high, medium, low]
        responsavel_id:
          type: string
        contato_id:
          type: string
        data_vencimento:
          type: string
          format: date-time
        subtarefas:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              titulo:
                type: string
              concluida:
                type: boolean
        criada_em:
          type: string
          format: date-time

    CriarTarefaRequest:
      type: object
      required: [titulo, responsavel_id]
      properties:
        titulo:
          type: string
        descricao:
          type: string
        prioridade:
          type: string
          enum: [urgent, high, medium, low]
        responsavel_id:
          type: string
          format: uuid
        contato_id:
          type: string
          format: uuid
        data_vencimento:
          type: string
          format: date-time

    AtualizarTarefaRequest:
      type: object
      properties:
        titulo:
          type: string
        descricao:
          type: string
        status:
          type: string
          enum: [todo, in_progress, done]
        prioridade:
          type: string
        data_vencimento:
          type: string
          format: date-time

  responses:
    NaoAutorizado:
      description: Token inválido ou ausente
      content:
        application/json:
          schema:
            type: object
            properties:
              sucesso:
                type: boolean
                example: false
              success:
                type: boolean
                example: false
              erro:
                type: string
                example: 'API key inválida'
              error:
                type: string
                example: 'Invalid API key'

    RequisicaoInvalida:
      description: Dados inválidos
      content:
        application/json:
          schema:
            type: object
            properties:
              sucesso:
                type: boolean
                example: false
              success:
                type: boolean
                example: false
              erro:
                type: string
              error:
                type: string

    NaoEncontrado:
      description: Recurso não encontrado
      content:
        application/json:
          schema:
            type: object
            properties:
              sucesso:
                type: boolean
                example: false
              success:
                type: boolean
                example: false
              erro:
                type: string
                example: 'Recurso não encontrado'
              error:
                type: string
                example: 'Resource not found'
