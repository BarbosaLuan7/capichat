openapi: 3.0.3
info:
  title: GaranteDireito CRM API
  version: 1.0.0
  description: |
    API RESTful para integração externa com o GaranteDireito CRM.
    
    ## Autenticação
    
    Todas as requisições devem incluir um header de autorização com a API Key:
    
    ```
    Authorization: Bearer {sua_api_key}
    ```
    
    ## Rate Limiting
    
    - 100 requests/minuto para envio de mensagens
    - 1000 requests/minuto para operações de leitura
    
    ## Paginação
    
    Endpoints de listagem suportam paginação via query params:
    - `page`: Número da página (padrão: 1)
    - `page_size`: Itens por página (padrão: 50, máximo: 100)
  contact:
    name: GaranteDireito Suporte
    email: suporte@garantedireito.com
  license:
    name: Proprietária

servers:
  - url: https://vnsypopnzwtkmyvxvqpu.supabase.co/functions/v1
    description: Produção

security:
  - BearerAuth: []

tags:
  - name: Leads
    description: Gerenciamento de leads/contatos
  - name: Mensagens
    description: Envio e recebimento de mensagens
  - name: Conversas
    description: Gerenciamento de conversas/atendimentos
  - name: Tags
    description: Gerenciamento de etiquetas
  - name: Templates
    description: Templates de mensagens
  - name: Webhooks
    description: Endpoints para receber eventos de provedores externos (WAHA, Evolution API)

paths:
  /api-leads:
    get:
      tags: [Leads]
      summary: Listar leads ou buscar por ID/telefone
      description: |
        Retorna lista paginada de leads com filtros opcionais.
        Use o parâmetro `id` para buscar um lead específico, ou `phone` para buscar por telefone.
      parameters:
        - name: id
          in: query
          description: ID do lead (retorna apenas o lead específico)
          schema:
            type: string
            format: uuid
        - name: phone
          in: query
          description: Telefone do lead (busca exata)
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
        - name: status
          in: query
          schema:
            type: string
            enum: [active, archived, converted, lost]
        - name: temperature
          in: query
          schema:
            type: string
            enum: [cold, warm, hot]
        - name: stage_id
          in: query
          schema:
            type: string
            format: uuid
        - name: assigned_to
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Lead(s) encontrado(s)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/Lead'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Lead'
                      pagination:
                        $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    post:
      tags: [Leads]
      summary: Criar lead
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateLeadRequest'
            example:
              name: Maria Silva
              phone: "5545999957851"
              email: maria@email.com
              source: facebook_ads
              temperature: warm
      responses:
        '201':
          description: Lead criado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Lead'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

    put:
      tags: [Leads]
      summary: Atualizar lead
      description: Atualiza um lead existente. O parâmetro `id` é obrigatório.
      parameters:
        - name: id
          in: query
          required: true
          description: ID do lead a ser atualizado
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateLeadRequest'
      responses:
        '200':
          description: Lead atualizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Lead'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags: [Leads]
      summary: Remover lead
      description: Remove um lead. O parâmetro `id` é obrigatório.
      parameters:
        - name: id
          in: query
          required: true
          description: ID do lead a ser removido
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Lead removido
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '404':
          $ref: '#/components/responses/NotFound'

  /api-messages-send:
    post:
      tags: [Mensagens]
      summary: Enviar mensagem
      description: Envia mensagem de texto, mídia ou template via WhatsApp
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/SendTextMessage'
                - $ref: '#/components/schemas/SendMediaMessage'
            examples:
              text:
                summary: Mensagem de texto
                value:
                  phone: "5545999957851"
                  message: "Olá, tudo bem?"
              image:
                summary: Enviar imagem
                value:
                  phone: "5545999957851"
                  type: image
                  media_url: "https://example.com/image.jpg"
                  message: "Veja esta imagem"
      responses:
        '200':
          description: Mensagem enviada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '429':
          description: Rate limit excedido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api-messages-receive:
    post:
      tags: [Mensagens]
      summary: Receber mensagem (webhook)
      description: |
        Endpoint para receber mensagens de provedores externos (WAHA, Evolution, Z-API).
        
        Este endpoint é chamado pelos webhooks dos provedores de WhatsApp quando uma nova mensagem é recebida.
        O sistema automaticamente:
        - Cria ou atualiza o lead baseado no número do telefone
        - Cria ou atualiza a conversa
        - Dispara webhooks configurados para `message.received`
        - Dispara automações configuradas
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReceiveMessageRequest'
            examples:
              texto:
                summary: Mensagem de texto
                value:
                  phone: "5545999957851"
                  message: "Olá, gostaria de informações sobre o BPC"
                  type: text
                  sender_name: "João Silva"
              imagem:
                summary: Mensagem com imagem
                value:
                  phone: "5545999957851"
                  message: "Segue meu documento"
                  type: image
                  media_url: "https://example.com/image.jpg"
                  external_id: "wamid.xxx"
      responses:
        '200':
          description: Mensagem processada com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReceiveMessageResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api-conversations:
    get:
      tags: [Conversas]
      summary: Listar conversas ou buscar por ID
      description: |
        Retorna lista paginada de conversas com filtros opcionais.
        Use o parâmetro `id` para buscar uma conversa específica com suas mensagens.
      parameters:
        - name: id
          in: query
          description: ID da conversa (retorna conversa com mensagens)
          schema:
            type: string
            format: uuid
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            default: 50
        - name: status
          in: query
          schema:
            type: string
            enum: [open, pending, resolved]
        - name: assigned_to
          in: query
          schema:
            type: string
            format: uuid
        - name: lead_id
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Conversa(s) encontrada(s)
          content:
            application/json:
              schema:
                oneOf:
                  - allOf:
                      - $ref: '#/components/schemas/Conversation'
                      - type: object
                        properties:
                          messages:
                            type: array
                            items:
                              $ref: '#/components/schemas/Message'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Conversation'
                      pagination:
                        $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    post:
      tags: [Conversas]
      summary: Criar conversa
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [lead_id]
              properties:
                lead_id:
                  type: string
                  format: uuid
                assigned_to:
                  type: string
                  format: uuid
                status:
                  type: string
                  enum: [open, pending, resolved]
                  default: open
      responses:
        '201':
          description: Conversa criada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Conversation'
        '400':
          $ref: '#/components/responses/BadRequest'

    put:
      tags: [Conversas]
      summary: Atualizar conversa
      description: Atualiza uma conversa existente. O parâmetro `id` é obrigatório.
      parameters:
        - name: id
          in: query
          required: true
          description: ID da conversa a ser atualizada
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [open, pending, resolved]
                assigned_to:
                  type: string
                  format: uuid
                is_favorite:
                  type: boolean
      responses:
        '200':
          description: Conversa atualizada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Conversation'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags: [Conversas]
      summary: Remover conversa
      description: Remove uma conversa. O parâmetro `id` é obrigatório.
      parameters:
        - name: id
          in: query
          required: true
          description: ID da conversa a ser removida
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Conversa removida
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '404':
          $ref: '#/components/responses/NotFound'

  /api-tags:
    get:
      tags: [Tags]
      summary: Listar etiquetas ou buscar por ID
      description: |
        Retorna lista de etiquetas, opcionalmente filtradas por categoria.
        Use o parâmetro `id` para buscar uma etiqueta específica.
        Use `action=lead` com `lead_id` para listar etiquetas de um lead específico.
      parameters:
        - name: id
          in: query
          description: ID da etiqueta (retorna apenas a etiqueta específica)
          schema:
            type: string
            format: uuid
        - name: category
          in: query
          description: Filtrar por categoria
          schema:
            type: string
            enum: [origem, interesse, prioridade, status, beneficio, condicao_saude, desqualificacao, situacao, perda]
        - name: action
          in: query
          description: Use 'lead' para operações com etiquetas do lead
          schema:
            type: string
            enum: [lead]
        - name: lead_id
          in: query
          description: ID do lead (requerido quando action=lead)
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Etiqueta(s) encontrada(s)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/Tag'
                  - type: array
                    items:
                      $ref: '#/components/schemas/Tag'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    post:
      tags: [Tags]
      summary: Criar etiqueta ou adicionar etiquetas ao lead
      description: |
        Cria uma nova etiqueta.
        Use `action=lead` com `lead_id` para adicionar etiquetas a um lead.
      parameters:
        - name: action
          in: query
          description: Use 'lead' para adicionar etiquetas ao lead
          schema:
            type: string
            enum: [lead]
        - name: lead_id
          in: query
          description: ID do lead (requerido quando action=lead)
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - type: object
                  description: Criar nova etiqueta
                  required: [name]
                  properties:
                    name:
                      type: string
                    color:
                      type: string
                      default: "#6B7280"
                    category:
                      type: string
                      enum: [origem, interesse, prioridade, status, beneficio, condicao_saude, desqualificacao, situacao, perda]
                      default: status
                - type: object
                  description: Adicionar etiquetas ao lead
                  properties:
                    tag_id:
                      type: string
                      format: uuid
                    tag_ids:
                      type: array
                      items:
                        type: string
                        format: uuid
            examples:
              criar_etiqueta:
                summary: Criar nova etiqueta
                value:
                  name: "Cliente VIP"
                  color: "#10B981"
                  category: "prioridade"
              adicionar_ao_lead:
                summary: Adicionar etiquetas ao lead
                value:
                  tag_ids: ["uuid-1", "uuid-2"]
      responses:
        '201':
          description: Etiqueta criada ou adicionada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tag'
        '400':
          $ref: '#/components/responses/BadRequest'

    put:
      tags: [Tags]
      summary: Atualizar etiqueta
      description: Atualiza uma etiqueta existente. O parâmetro `id` é obrigatório.
      parameters:
        - name: id
          in: query
          required: true
          description: ID da etiqueta a ser atualizada
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                color:
                  type: string
                category:
                  type: string
                  enum: [origem, interesse, prioridade, status, beneficio, condicao_saude, desqualificacao, situacao, perda]
      responses:
        '200':
          description: Etiqueta atualizada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tag'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags: [Tags]
      summary: Remover etiqueta ou remover etiqueta do lead
      description: |
        Remove uma etiqueta. O parâmetro `id` é obrigatório.
        Use `action=lead` com `lead_id` e `tag_id` para remover etiqueta de um lead.
      parameters:
        - name: id
          in: query
          description: ID da etiqueta a ser removida
          schema:
            type: string
            format: uuid
        - name: action
          in: query
          description: Use 'lead' para remover etiqueta do lead
          schema:
            type: string
            enum: [lead]
        - name: lead_id
          in: query
          description: ID do lead (requerido quando action=lead)
          schema:
            type: string
            format: uuid
        - name: tag_id
          in: query
          description: ID da etiqueta a remover do lead (requerido quando action=lead)
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Etiqueta removida
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '404':
          $ref: '#/components/responses/NotFound'

  /api-templates:
    get:
      tags: [Templates]
      summary: Listar templates ou buscar por ID/atalho
      description: |
        Retorna lista de templates.
        Use o parâmetro `id` para buscar um template específico.
        Use o parâmetro `shortcut` para buscar por atalho.
      parameters:
        - name: id
          in: query
          description: ID do template
          schema:
            type: string
            format: uuid
        - name: shortcut
          in: query
          description: Buscar por atalho
          schema:
            type: string
      responses:
        '200':
          description: Template(s) encontrado(s)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/Template'
                  - type: array
                    items:
                      $ref: '#/components/schemas/Template'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    post:
      tags: [Templates]
      summary: Criar template
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, shortcut, content]
              properties:
                name:
                  type: string
                shortcut:
                  type: string
                  description: "Atalho para usar com /"
                content:
                  type: string
                  description: "Conteudo com variaveis {{nome}}, {{telefone}}, etc."
            example:
              name: Boas-vindas
              shortcut: oi
              content: "Olá {{nome}}! Bem-vindo à GaranteDireito. Como posso ajudar?"
      responses:
        '201':
          description: Template criado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Template'
        '400':
          $ref: '#/components/responses/BadRequest'

    put:
      tags: [Templates]
      summary: Atualizar template
      description: Atualiza um template existente. O parâmetro `id` é obrigatório.
      parameters:
        - name: id
          in: query
          required: true
          description: ID do template a ser atualizado
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                shortcut:
                  type: string
                content:
                  type: string
      responses:
        '200':
          description: Template atualizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Template'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags: [Templates]
      summary: Remover template
      description: Remove um template. O parâmetro `id` é obrigatório.
      parameters:
        - name: id
          in: query
          required: true
          description: ID do template a ser removido
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Template removido
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '404':
          $ref: '#/components/responses/NotFound'

  /whatsapp-webhook:
    post:
      tags: [Webhooks]
      summary: Webhook WAHA / Evolution API
      description: |
        Endpoint para receber eventos do WAHA (WhatsApp HTTP API) ou Evolution API.
        Configure este URL no seu provedor de WhatsApp como webhook.
        
        **Formatos suportados:**
        - WAHA (WhatsApp HTTP API)
        - Evolution API
        
        **Eventos processados:**
        - `message` / `message.any` - Nova mensagem recebida
        - `message.ack` - Atualizacao de status de mensagem
        - `messages.upsert` (Evolution) - Nova mensagem
        - `messages.update` (Evolution) - Atualizacao de mensagem
        
        **Configuracao:**
        1. Acesse Configuracoes > WhatsApp no CRM
        2. Configure a URL base do seu provedor WAHA/Evolution
        3. Use esta URL como webhook no seu provedor
        4. (Opcional) Configure um webhook_secret para validacao HMAC-SHA256
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/WAHAWebhookPayload'
                - $ref: '#/components/schemas/EvolutionWebhookPayload'
            examples:
              waha_message:
                summary: Mensagem WAHA (texto)
                value:
                  event: message
                  session: default
                  payload:
                    id: "wamid.HBgNNTU0NTk5OTk1Nzg1MRUCABIYIDc4YzZkM2E0"
                    timestamp: 1735300000
                    from: "5545999957851@c.us"
                    to: "5545000000000@c.us"
                    body: "Ola, preciso de ajuda com o BPC"
                    hasMedia: false
                    type: chat
                    fromMe: false
                  me:
                    id: "5545000000000@c.us"
                    pushName: "GaranteDireito"
              waha_media:
                summary: Mensagem WAHA (imagem)
                value:
                  event: message
                  session: default
                  payload:
                    id: "wamid.HBgNNTU0NTk5OTk1Nzg1MRUCABIYIDc4YzZkM2E0"
                    timestamp: 1735300000
                    from: "5545999957851@c.us"
                    to: "5545000000000@c.us"
                    body: "Segue meu documento"
                    hasMedia: true
                    type: image
                    fromMe: false
                    mediaUrl: "https://api.example.com/media/xxx"
                  me:
                    id: "5545000000000@c.us"
              waha_ack:
                summary: Confirmacao de leitura WAHA
                value:
                  event: message.ack
                  session: default
                  payload:
                    id: "wamid.xxx"
                    ack: 3
                    ackName: read
              evolution_message:
                summary: Mensagem Evolution API
                value:
                  event: messages.upsert
                  instance: minha-instancia
                  data:
                    key:
                      remoteJid: "5545999957851@s.whatsapp.net"
                      fromMe: false
                      id: "3EB0XXXX"
                    pushName: "Joao Silva"
                    message:
                      conversation: "Preciso de ajuda"
      responses:
        '200':
          description: Evento processado (ignorado ou duplicado)
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ignored
                  message:
                    type: string
        '201':
          description: Mensagem criada com sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: created
                  message_id:
                    type: string
                    format: uuid
                  lead_id:
                    type: string
                    format: uuid
                  conversation_id:
                    type: string
                    format: uuid
        '400':
          description: Payload invalido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Assinatura do webhook invalida
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: API Key obtida em Configurações > API

  schemas:
    Lead:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        phone:
          type: string
        email:
          type: string
        cpf:
          type: string
        birth_date:
          type: string
          format: date
        source:
          type: string
        status:
          type: string
          enum: [active, archived, converted, lost]
        temperature:
          type: string
          enum: [cold, warm, hot]
        stage_id:
          type: string
          format: uuid
        assigned_to:
          type: string
          format: uuid
        benefit_type:
          type: string
        case_status:
          type: string
        avatar_url:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateLeadRequest:
      type: object
      required: [name, phone]
      properties:
        name:
          type: string
        phone:
          type: string
        email:
          type: string
        cpf:
          type: string
        source:
          type: string
          default: api
        temperature:
          type: string
          enum: [cold, warm, hot]
          default: cold
        stage_id:
          type: string
          format: uuid
        assigned_to:
          type: string
          format: uuid
        benefit_type:
          type: string

    UpdateLeadRequest:
      type: object
      properties:
        name:
          type: string
        phone:
          type: string
        email:
          type: string
        cpf:
          type: string
        status:
          type: string
          enum: [active, archived, converted, lost]
        temperature:
          type: string
          enum: [cold, warm, hot]
        stage_id:
          type: string
          format: uuid
        assigned_to:
          type: string
          format: uuid
        benefit_type:
          type: string
        case_status:
          type: string

    Conversation:
      type: object
      properties:
        id:
          type: string
          format: uuid
        lead_id:
          type: string
          format: uuid
        assigned_to:
          type: string
          format: uuid
        status:
          type: string
          enum: [open, pending, resolved]
        is_favorite:
          type: boolean
        unread_count:
          type: integer
        last_message_at:
          type: string
          format: date-time
        last_message_content:
          type: string
        created_at:
          type: string
          format: date-time
        lead:
          $ref: '#/components/schemas/LeadSummary'

    LeadSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        phone:
          type: string
        avatar_url:
          type: string

    Message:
      type: object
      properties:
        id:
          type: string
          format: uuid
        conversation_id:
          type: string
          format: uuid
        sender_id:
          type: string
          format: uuid
        sender_type:
          type: string
          enum: [lead, agent]
        type:
          type: string
          enum: [text, image, audio, video, document]
        content:
          type: string
        media_url:
          type: string
        status:
          type: string
          enum: [sent, delivered, read]
        direction:
          type: string
          enum: [inbound, outbound]
        created_at:
          type: string
          format: date-time

    SendTextMessage:
      type: object
      required: [phone, message]
      properties:
        phone:
          type: string
          description: "Número do WhatsApp com código do país (ex: 5545999957851)"
        message:
          type: string
          description: Texto da mensagem
        type:
          type: string
          enum: [text, image, audio, video, document]
          default: text
          description: "Tipo da mensagem (padrao: text)"
        lead_id:
          type: string
          format: uuid
          description: "ID do lead (opcional, sera buscado pelo telefone se nao informado)"
        conversation_id:
          type: string
          format: uuid
          description: "ID da conversa (opcional, sera buscada ou criada automaticamente)"
        whatsapp_instance_id:
          type: string
          format: uuid
          description: "ID da instância WhatsApp a usar para envio. Se omitido, usa a primeira ativa. Importante para separar conversas por número."

    SendMediaMessage:
      type: object
      required: [phone, type, media_url]
      properties:
        phone:
          type: string
          description: "Número do WhatsApp com código do país (ex: 5545999957851)"
        type:
          type: string
          enum: [image, audio, video, document]
        media_url:
          type: string
          format: uri
          description: URL pública da mídia a ser enviada
        message:
          type: string
          description: Legenda da mídia
        lead_id:
          type: string
          format: uuid
          description: ID do lead (opcional)
        conversation_id:
          type: string
          format: uuid
          description: ID da conversa (opcional)
        whatsapp_instance_id:
          type: string
          format: uuid
          description: "ID da instância WhatsApp a usar para envio. Se omitido, usa a primeira ativa."

    MessageResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Indica se a mensagem foi enviada com sucesso
        messageId:
          type: string
          description: ID da mensagem no provedor (WAHA/Evolution/Z-API)
        provider:
          type: string
          enum: [waha, evolution, z-api, custom]
          description: Provedor utilizado para enviar a mensagem
        conversation_id:
          type: string
          format: uuid
          description: ID da conversa onde a mensagem foi salva
        lead_id:
          type: string
          format: uuid
          description: ID do lead associado

    ReceiveMessageRequest:
      type: object
      required: [phone, message]
      description: Payload recebido do webhook do provedor de WhatsApp
      properties:
        phone:
          type: string
          description: "Número do WhatsApp do remetente com código do país"
          example: "5545999957851"
        message:
          type: string
          description: Conteúdo da mensagem
        type:
          type: string
          enum: [text, image, audio, video, document]
          default: text
          description: "Tipo da mensagem"
        media_url:
          type: string
          format: uri
          description: "URL da midia (quando type != text)"
        timestamp:
          type: string
          format: date-time
          description: "Data/hora da mensagem no WhatsApp"
        external_id:
          type: string
          description: "ID unico da mensagem no provedor (wamid)"
        sender_name:
          type: string
          description: "Nome do contato no WhatsApp"

    ReceiveMessageResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            message:
              type: object
              properties:
                id:
                  type: string
                  format: uuid
                content:
                  type: string
                type:
                  type: string
                created_at:
                  type: string
                  format: date-time
            lead:
              type: object
              properties:
                id:
                  type: string
                  format: uuid
                name:
                  type: string
                phone:
                  type: string
                is_new:
                  type: boolean
                  description: "True se o lead foi criado nesta requisicao"
            conversation:
              type: object
              properties:
                id:
                  type: string
                  format: uuid
                is_new:
                  type: boolean
                  description: "True se a conversa foi criada nesta requisicao"

    Tag:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        color:
          type: string
        category:
          type: string
          enum: [origem, interesse, prioridade, status, beneficio, condicao_saude, desqualificacao, situacao, perda]
        created_at:
          type: string
          format: date-time

    Template:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        shortcut:
          type: string
        content:
          type: string
        created_at:
          type: string
          format: date-time

    Pagination:
      type: object
      properties:
        page:
          type: integer
        page_size:
          type: integer
        total:
          type: integer
        total_pages:
          type: integer

    Error:
      type: object
      properties:
        error:
          type: string

    WAHAWebhookPayload:
      type: object
      description: |
        Payload enviado pelo WAHA (WhatsApp HTTP API).
        
        **Nota:** O WAHA pode enviar dados adicionais em campos internos como `_data` 
        que contêm informações extras do WhatsApp (participante real, timestamp detalhado, etc).
        Esses campos são processados internamente mas não são documentados aqui.
      required: [event, session, payload]
      properties:
        event:
          type: string
          enum: [message, message.any, message.ack, session.status]
          description: Tipo do evento WAHA
        session:
          type: string
          description: Nome da sessao WAHA (ex - default)
          example: default
        engine:
          type: string
          description: "Engine WAHA em uso (WEBJS, NOWEB, VENOM, etc)"
          example: "NOWEB"
        payload:
          $ref: '#/components/schemas/WAHAMessage'
        me:
          type: object
          description: Informacoes do numero conectado
          properties:
            id:
              type: string
              description: "ID do numero (formato: numero@c.us)"
              example: "5545000000000@c.us"
            pushName:
              type: string
              description: Nome exibido no WhatsApp
              example: GaranteDireito

    WAHAMessage:
      type: object
      description: |
        Dados da mensagem no formato WAHA.
        
        O conteúdo da mensagem pode vir em diferentes campos dependendo do tipo:
        - Texto: campo `body`
        - Mídia: campos `mediaUrl` ou objeto `media`
        - Localização: campos `location.latitude` e `location.longitude`
      properties:
        id:
          type: string
          description: "ID unico da mensagem (wamid)"
          example: "wamid.HBgNNTU0NTk5OTk1Nzg1MRUCABIYIDc4YzZkM2E0"
        timestamp:
          type: integer
          description: Timestamp Unix da mensagem (segundos)
          example: 1735300000
        from:
          type: string
          description: "Remetente (formato: numero@c.us)"
          example: "5545999957851@c.us"
        to:
          type: string
          description: "Destinatario (formato: numero@c.us)"
          example: "5545000000000@c.us"
        chatId:
          type: string
          description: "ID do chat (alternativo ao from/to, formato: numero@c.us)"
          example: "5545999957851@c.us"
        body:
          type: string
          description: Conteudo da mensagem de texto
          example: "Ola, preciso de ajuda"
        hasMedia:
          type: boolean
          description: Indica se a mensagem contem midia
          example: false
        type:
          type: string
          enum: [chat, image, video, audio, document, ptt, sticker, location]
          description: Tipo da mensagem
          example: chat
        fromMe:
          type: boolean
          description: True se a mensagem foi enviada por nos
          example: false
        pushName:
          type: string
          description: Nome do contato no WhatsApp
          example: "Joao Silva"
        mediaUrl:
          type: string
          format: uri
          description: URL da midia (quando hasMedia = true)
        media:
          type: object
          description: "Objeto de mídia alternativo (usado em algumas versões do WAHA)"
          properties:
            url:
              type: string
              format: uri
              description: URL para download da mídia
              example: "https://waha.example.com/api/files/default/media_xxx.jpg"
            filename:
              type: string
              description: Nome do arquivo
              example: "documento.pdf"
            mimetype:
              type: string
              description: Tipo MIME do arquivo
              example: "image/jpeg"
        location:
          type: object
          description: "Dados de localização (quando type = location)"
          properties:
            latitude:
              type: number
              format: double
              example: -25.4284
            longitude:
              type: number
              format: double
              example: -49.2733
            description:
              type: string
              description: Descrição do local
        ack:
          type: integer
          enum: [0, 1, 2, 3, 4]
          description: "Status de confirmacao (0=pending, 1=sent, 2=delivered, 3=read, 4=played)"
        ackName:
          type: string
          enum: [pending, sent, delivered, read, played]
          description: Nome do status de confirmacao

    EvolutionWebhookPayload:
      type: object
      description: Payload enviado pela Evolution API
      required: [event, instance, data]
      properties:
        event:
          type: string
          enum: [messages.upsert, messages.update, connection.update]
          description: Tipo do evento Evolution
        instance:
          type: string
          description: Nome da instancia Evolution
          example: minha-instancia
        data:
          $ref: '#/components/schemas/EvolutionMessageData'

    EvolutionMessageData:
      type: object
      description: Dados da mensagem no formato Evolution API
      properties:
        key:
          type: object
          properties:
            remoteJid:
              type: string
              description: "JID do contato (formato: numero@s.whatsapp.net)"
              example: "5545999957851@s.whatsapp.net"
            fromMe:
              type: boolean
              description: True se a mensagem foi enviada por nos
            id:
              type: string
              description: ID da mensagem
              example: "3EB0XXXX"
        pushName:
          type: string
          description: Nome do contato
          example: "Joao Silva"
        message:
          type: object
          description: Conteudo da mensagem
          properties:
            conversation:
              type: string
              description: Texto da mensagem (mensagens simples)
            extendedTextMessage:
              type: object
              properties:
                text:
                  type: string
            imageMessage:
              type: object
              properties:
                url:
                  type: string
                caption:
                  type: string
            audioMessage:
              type: object
              properties:
                url:
                  type: string
            videoMessage:
              type: object
              properties:
                url:
                  type: string
                caption:
                  type: string
            documentMessage:
              type: object
              properties:
                url:
                  type: string
                fileName:
                  type: string

  responses:
    BadRequest:
      description: Requisição inválida
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Unauthorized:
      description: API Key inválida ou ausente
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFound:
      description: Recurso não encontrado
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
